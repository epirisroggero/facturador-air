<?xml version="1.0" encoding="utf-8"?>
<s:HGroup xmlns:components1="biz.fulltime.ui.components.*" xmlns:fx="http://ns.adobe.com/mxml/2009" xmlns:mx="library://ns.adobe.com/flex/mx" xmlns:s="library://ns.adobe.com/flex/spark"
		  width="100%" height="100%" creationComplete="creationCompleteHandler(event)" show="showHandler(event)">
	<fx:Script>
		<![CDATA[
			import biz.fulltime.ui.forms.DGNumStepperEditor;
			import biz.fulltime.ui.forms.FrmNotaLinea;
			import biz.fulltime.conf.GeneralOptions;
			import biz.fulltime.model.Cuponera;
			import biz.fulltime.model.Documento;
			import biz.fulltime.model.LineaDocumento;
			import biz.fulltime.model.LineasDocumento;
			import biz.fulltime.model.Moneda;
			import biz.fulltime.model.Usuario;
			import biz.fulltime.ui.facturacion.stockprecio.StockArticuloPnl;
			
			import mx.collections.ArrayCollection;
			import mx.collections.IList;
			import mx.controls.Alert;
			import mx.core.FlexGlobals;
			import mx.core.IFlexDisplayObject;
			import mx.events.CloseEvent;
			import mx.events.FlexEvent;
			import mx.managers.PopUpManager;
			import mx.rpc.events.FaultEvent;
			
			import spark.components.TitleWindow;
			import spark.components.gridClasses.CellPosition;
			import spark.events.GridItemEditorEvent;
			import spark.events.GridSelectionEvent;
			
			import util.CatalogoFactory;
			
			private var helpWindow:TitleWindow;
			
			private var ddNum:DGNumStepperEditor = new DGNumStepperEditor();
			
			private var _lineasDocumento:LineasDocumento;
			
			private var _moneda:Moneda;
			
			private var _documento:Documento;
			
			private var cellPos:CellPosition;
			
			private var _changeLineasGasto:Boolean;
						
			public var tieneCambios:Boolean = false;
			
			private var _conceptos:ArrayCollection;
			
			
			[Bindable]
			private var currentLine:LineaDocumento;
			
			[Bindable]
			public var hay_vendedor_dist:Boolean;
						
			[Bindable]
			public function get documento():Documento {
				return _documento;
			}
			
			public function set documento(value:Documento):void {
				_documento = value;
								
				if (_conceptos == null) {
					_conceptos = new ArrayCollection();
				} else {
					_conceptos.removeAll();
				}				
				_conceptos.addAll(CatalogoFactory.getInstance().conceptos);
				
			}
									
			[Bindable(event="monedaChange")]
			public function get moneda():Moneda {
				return _moneda;
			}
			
			public function set moneda(value:Moneda):void {
				if (_moneda !== value) {
					_moneda = value;
					dispatchEvent(new Event("monedaChange"));
				}
			}
			
			protected function creationCompleteHandler(event:FlexEvent):void {
				callLater(function():void {
					dgLineasGasto.setFocus();
					if (dgLineasGasto.dataProvider.length > 0) {
						dgLineasGasto.setSelectedCell(0, 0);						
						currentLine = lineasDocumento.lineas[0];
					}
				});
			}
			
			[Bindable]
			public function get lineasDocumento():LineasDocumento {
				return _lineasDocumento;
			}
			
			public function set lineasDocumento(value:LineasDocumento):void {
				_lineasDocumento = value;
				_changeLineasGasto = true;
				invalidateProperties();
			}
			
			override protected function commitProperties():void {
				super.commitProperties();
				
				if (_changeLineasGasto) {
					_changeLineasGasto = false;
					
					if (!_lineasDocumento) {
						_lineasDocumento = new LineasDocumento();
						_lineasDocumento.documento = documento;
					}
					if (lineasDocumento.lineas.length < 1) {
						var nueva:LineaDocumento = new LineaDocumento();
						nueva.documento = documento;
						lineasDocumento.lineas.addItem(nueva);
					}
					dgLineasGasto.dataProvider = lineasDocumento.lineas;
				}
			}
			
			private function convertirMoneda(cuponera:Cuponera):BigDecimal {
				return documento.convertirMoneda(cuponera.moneda, documento.moneda, new BigDecimal(cuponera.precioUnitario));
			}
			
			private function closePnlHelpHandler(event:CloseEvent):void {
				event.target.removeEventListener(CloseEvent.CLOSE, closePnlHelpHandler);
				PopUpManager.removePopUp(event.target as IFlexDisplayObject);
				dgLineasGasto.setFocus();
			}
			
			protected function dg_keyDownHandler(event:KeyboardEvent):void {
				cellPos = dgLineasGasto.selectedCell;
				
				const columns1:IList = dgLineasGasto.columns;
				var col2:GridColumn = ((cellPos.columnIndex >= 0) && (cellPos.columnIndex < columns1.length)) ? columns1.getItemAt(cellPos.columnIndex) as GridColumn : null;
				var dataField:String = col2 ? col2.dataField : "";
				
				var superuser:Boolean = GeneralOptions.getInstance().loggedUser.esSupervisor();
				
				var permitirNegativos:Boolean = false;
				var codigoComprobante:String = _documento.comprobante.codigo;
				var maxRow:int = 0;
				
				
				if (event.keyCode == Keyboard.INSERT) { // Se presiono la tecla 'INSERT'
					maxRow = dgLineasGasto.dataProvider.length - 1;
					if (hasPermEdition()) {
						if (maxRow + 2 > 17 && !documento.comprobante.esImportacion()) {
							Alert.show("Se pueden agregar un máximo de 17 líneas.");
						} else {
							agregarLineaGasto();
						}
					}
					
				} else if (event.keyCode == Keyboard.ESCAPE) { // Se presiono la tecla 'ESC'
					if (validateLines()) {
						dispatchEvent(new CloseEvent(CloseEvent.CLOSE));
					}
					
				} else if (event.keyCode == Keyboard.ENTER) {
					var count:int = 0;
					var columns:ArrayCollection = new ArrayCollection(dgLineasGasto.columns.toArray());
					for each (var col:GridColumn in columns) {
						if (col.visible) {
							count++;
						}
					}
					var maxCol:int = columns.length - 3;
					maxRow = dgLineasGasto.dataProvider.length - 1;
					
					var colIndex:int;
					var rowIndex:int;
					if (cellPos == null) {
						colIndex = dgLineasGasto.editorColumnIndex;
						rowIndex = dgLineasGasto.editorRowIndex
					} else {
						var i:int = 1;
						while (!columns[cellPos.columnIndex + i].visible) {
							i++;
						}
						
						colIndex = cellPos.columnIndex + i;
						rowIndex = cellPos.rowIndex;
					}
					if (colIndex > maxCol) {
						colIndex = 2;
						if (rowIndex == maxRow) {
							if (hasPermEdition())
								if (maxRow + 2 > 17 && !documento.comprobante.esImportacion()) {
									Alert.show("Se pueden agregar un máximo de 17 líneas.");
								} else {
									agregarLineaGasto();
								}
						} else {
							rowIndex += 1;
							currentLine = dgLineasGasto.dataProvider.getItemAt(rowIndex) as LineaDocumento;
						}
					}
					
					dgLineasGasto.setSelectedCell(rowIndex, colIndex);
					
				} else if ((permitirNegativos && (event.keyCode == Keyboard.MINUS || event.keyCode == Keyboard.NUMPAD_SUBTRACT)) || (event.keyCode >= Keyboard.A && event.keyCode <= Keyboard.Z) || (event.keyCode >= Keyboard.NUMBER_0 && event.keyCode <= Keyboard.NUMBER_9) || (event.keyCode >= Keyboard.NUMPAD_0 && event.keyCode <= Keyboard.NUMPAD_9) || event.keyCode == Keyboard.NUMPAD_DECIMAL || event.keyCode == Keyboard.PERIOD) {
					if (hasPermEdition()) {
						if ((dgLineasGasto.columns.getItemAt(cellPos.columnIndex) as GridColumn).editable) {
							dgLineasGasto.startItemEditorSession(cellPos.rowIndex, cellPos.columnIndex);
						}
					}
				}
			}
			
			private function agregarLineaGasto():void {
				var nueva:LineaDocumento = new LineaDocumento();
				nueva.documento = lineasDocumento.documento;
				lineasDocumento.lineas.addItem(nueva);
				
				currentLine = nueva;
				
				tieneCambios = true;
				
				callLater(function():void {
					var row:int = lineasDocumento.lineas.length - 1;
					var col:int = 2;
					dgLineasGasto.setSelectedCell(row, col);
					
					callLater(function():void {
						dgLineasGasto.setFocus();
					});
				});
				
			}
			
			private function antecedentesCloseHandler(event:CloseEvent):void {
				if (helpWindow) {
					helpWindow.removeEventListener(CloseEvent.CLOSE, antecedentesCloseHandler);
					PopUpManager.removePopUp(helpWindow as IFlexDisplayObject);
					dgLineasGasto.setFocus();
					helpWindow = null;
				}
			}
									
			private function closePnlHandler(event:CloseEvent):void {
				event.target.removeEventListener(CloseEvent.CLOSE, closePnlHandler);
				PopUpManager.removePopUp(event.target as IFlexDisplayObject);
				dgLineasGasto.setFocus();
			}
			
			protected function cmdAceptar_clickHandler(event:MouseEvent):void {
				if (validateLines()) {
					dispatchEvent(new CloseEvent(CloseEvent.CLOSE));
				} else {
					Alert.show("Los valores no son válidos", "Error");
				}
			}
			
			protected function cmdCancel_clickHandler(event:MouseEvent):void {
				if (validateLines()) {
					dispatchEvent(new CloseEvent(CloseEvent.CLOSE));
				}
			}
			
			private function validateLines():Boolean {
				var conceptosInactivos:ArrayCollection = new ArrayCollection();
				
				var borrarLineas:ArrayCollection = new ArrayCollection();
				for each (var linea:LineaDocumento in lineasDocumento.lineas) {
					if (!linea.articulo && (linea.conceptoIdLin == null || linea.conceptoIdLin == "")) {
						borrarLineas.addItem(linea);
					}
				}
				for each (var item:LineaDocumento in borrarLineas) {
					lineasDocumento.lineas.removeItemAt(lineasDocumento.lineas.getItemIndex(item));
				}
				
				return true;
			}
			
			private function handleFault(event:FaultEvent):void {
				var message:String = event.fault && event.fault.rootCause && event.fault.rootCause.localizedMessage ? event.fault.rootCause.localizedMessage : null;
				if (!message) {
					message = event.message.toString();
				}
				Alert.show(message, "Error", 4, null, null, StyleManager.getStyleManager(null).getStyleDeclaration('.icons32').getStyle('ErrorIcon'));
			}
			
			protected function showHandler(event:FlexEvent):void {
				dgLineasGasto.setFocus();
			}
			
			protected function dgLineasGasto_gridItemEditorSessionSaveHandler(event:GridItemEditorEvent):void {
				var ld2:LineaDocumento = lineasDocumento.lineas.getItemAt(event.rowIndex) as LineaDocumento;
				
				var field:String = event.column.dataField;
				
				if (field == "cantidad") {
					currentLine.obtenerStock();
					
				} else if (field == "concepto") {
					var concepto:String = ld2.getConcepto();
					if (concepto && concepto.length > 50) {
						ld2.setConcepto(concepto.substring(0, 49));
					}
				}
				
				dgLineasGasto.setSelectedCell(event.rowIndex, event.columnIndex);
				callLater(function():void {
					dgLineasGasto.setFocus();
				});
				
				tieneCambios = true;
			}
						
			public function borrarLineaGasto():void {
				var rowIndex:int = dgLineasGasto.selectedCell.rowIndex;
				
				if (lineasDocumento.lineas.length == 1) { // Tengo un solo elemento.
					lineasDocumento.lineas.removeItemAt(rowIndex);
					
					// Agregar una linea vacia al documento
					var lineaDoc:LineaDocumento = new LineaDocumento();
					lineaDoc.articulo = null;
					lineaDoc.documento = _documento;
					
					lineasDocumento.lineas.addItem(lineaDoc);
				} else {
					lineasDocumento.lineas.removeItemAt(rowIndex);
					dgLineasGasto.invalidateDisplayList();
				}
				
				callLater(function():void {
					var maxIndex:int = dgLineasGasto.dataProvider.length - 1;
					if (dgLineasGasto.dataProvider.length >= 0) {
						if (rowIndex == 0) {
							dgLineasGasto.setSelectedCell(rowIndex, 2);
						} else if (rowIndex > maxIndex) {
							dgLineasGasto.setSelectedCell(maxIndex, 2);
						} else {
							dgLineasGasto.setSelectedCell(rowIndex, 2);
						}
					}
				});
				
				tieneCambios = true;
			}
			
			public function editarNotas(linea:LineaDocumento):void {
				if (helpWindow == null) {
					tieneCambios = true;
					
					helpWindow = new TitleWindow();
					helpWindow.width = 540;
					helpWindow.height = 360;
					
					helpWindow.title = "Nota de la línea";
					helpWindow.visible = true;
					
					var notasLineaPnl:FrmNotaLinea = new FrmNotaLinea();
					notasLineaPnl.linea = linea;
					
					PopUpManager.addPopUp(helpWindow, Sprite(FlexGlobals.topLevelApplication), true);
					PopUpManager.centerPopUp(helpWindow);
					
					helpWindow.addEventListener(CloseEvent.CLOSE, notas_closeHandler);
					notasLineaPnl.addEventListener(CloseEvent.CLOSE, notas_closeHandler);
					
					helpWindow.addElement(notasLineaPnl);
				}
				
			}
			
			private function notas_closeHandler(event:CloseEvent):void {
				helpWindow.removeEventListener(CloseEvent.CLOSE, notas_closeHandler);
				PopUpManager.removePopUp(helpWindow as IFlexDisplayObject);
				helpWindow = null;
			}
			
			protected function dgLineasGasto_creationCompleteHandler(event:FlexEvent):void {
			}
						
			protected function dgLineasGasto_selectionChangeHandler(event:GridSelectionEvent):void {
				var rowIndex:int = event.selectionChange.rowIndex;
				
				currentLine = lineasDocumento.lineas[rowIndex];
			}
			
			private function hasPermEdition():Boolean {
				if (documento.nuevo) {
					return true;
				} else if (!documento.permisosDocumentoUsuario.edicion) {
					return false;
				} else if (documento.emitido) {
					return (GeneralOptions.getInstance().loggedUser.esSupervisor() || GeneralOptions.getInstance().loggedUser.permisoId == Usuario.USUARIO_ADMINISTRADOR);
				}
				
				return true;
			}
						
			
			[Bindable]
			public function get conceptos():ArrayCollection {
				return _conceptos;
			}
			
			
		]]>
	</fx:Script>
	
	<fx:Declarations>
		<s:NumberFormatter id="nf_Espanol_Espanol" fractionalDigits="2" locale="es_ES" />
		<s:NumberFormatter id="nf_Espanol_Espanol_2" fractionalDigits="0" locale="es_ES" />
	</fx:Declarations>
	
	<s:Panel width="100%" height="100%" styleName="pntLineasGasto">
		<s:VGroup width="100%" height="100%">
			<s:HGroup width="100%" height="100%" gap="0">
				<s:DataGrid id="dgLineasGasto" width="100%" height="100%" fontSize="12" creationComplete="dgLineasGasto_creationCompleteHandler(event)" keyDown="dg_keyDownHandler(event)"
							gridItemEditorSessionSave="dgLineasGasto_gridItemEditorSessionSaveHandler(event)" dataProvider="{lineasDocumento.lineas}" selectionMode="singleCell" sortableColumns="false"
							selectionChange="dgLineasGasto_selectionChangeHandler(event)" editable="{hasPermEdition()}">
					<s:columns>
						<s:ArrayList>
							
							<s:GridColumn width="80" dataField="cantidad" headerText="CANTIDAD" editable="{hasPermEdition()}" rendererIsEditable="false"
										  itemEditor="biz.fulltime.ui.forms.DGNumStepperEditor">
								<s:itemRenderer>
									<fx:Component>
										<s:DefaultGridItemRenderer textAlign="right">
											<fx:Script>
												<![CDATA[
													import biz.fulltime.model.LineaDocumento;
													
													override public function prepare(hasBeenRecycled:Boolean):void {
														if (!data) {
															return;
														}
														label = outerDocument.nf_Espanol_Espanol.format(LineaDocumento(data).getCantidad());
													}
												]]>
											</fx:Script>
										</s:DefaultGridItemRenderer>
									</fx:Component>
								</s:itemRenderer>
							</s:GridColumn>
							
							<s:GridColumn width="100" dataField="conceptoIdLin" headerText="CONCEPTO" editable="{hasPermEdition()}">
								<s:itemEditor>
									<fx:Component>
										<s:GridItemEditor>
											<fx:Script>
												<![CDATA[
													import biz.fulltime.model.Concepto;
													import biz.fulltime.model.Iva;
													import biz.fulltime.model.LineaDocumento;
													
													import mx.events.FlexEvent;
													import mx.utils.StringUtil;
													
													import spark.components.DataGrid;
													
													import util.CatalogoFactory;
													
													protected function acConcepto_creationCompleteHandler(event:FlexEvent):void {
														callLater(function():void {
															acConcepto.textInput.setFocus();
														});
													}
													
													override public function get value():Object {
														var concept:Concepto = acConcepto.selectedItem;
														return concept.codigo;
													}
													
													override public function set value(newValue:Object):void {
														if (!newValue) {
															return;
														}
														for each (var concept:Concepto in outerDocument.conceptos) {
															if (concept.codigo == newValue.toString()) {
																acConcepto.selectedItem = concept;	
																break;
															}															
														}									
													}
													
													public function codigoNombreLabelFunction(item:Object):String {
														var label:String;
														if (!item) {
															return "";
														}
														if (item.hasOwnProperty("codigo")) {
															label = item.codigo;
														}
														if (item.hasOwnProperty("nombre")) {
															label += " - " + String(item.nombre).toUpperCase();
														}
														return label;
													}
													
													protected function acConcepto_keyDownHandler(event:KeyboardEvent):void {
														if (event.keyCode == Keyboard.F1 || event.keyCode == Keyboard.F2) {
															if (!acConcepto.isPopUp) {
																DataGrid(owner).endItemEditorSession();
															}
														}
													}
													
													/**
													 *  @private
													 */
													override public function setFocus():void {
														acConcepto.setFocus();
													}
													
													protected function acConcepto_changeHandler(event:Event):void {
														var c2:Concepto = acConcepto.selectedItem as Concepto;
														if (c2 != null) {
															LineaDocumento(data).conceptoIdLin = c2.codigo;
															if (LineaDocumento(data).concepto == null || LineaDocumento(data).concepto.length == 0) {
																LineaDocumento(data).concepto = c2.nombre;	
																
																if (c2.ivaIdConcepto) {
																	for each(var iva:Iva in CatalogoFactory.getInstance().ivas) {
																		if (iva.codigo == c2.ivaIdConcepto.toString()) {
																			LineaDocumento(data).ivaLin = iva;
																		}																
																	}							

																}
															}
															
														}
														
													}
												]]>
											</fx:Script>
											<components1:MyAutoComplete id="acConcepto" width="100%" height="100%" change="acConcepto_changeHandler(event)"
																		creationComplete="acConcepto_creationCompleteHandler(event)" keyDown="acConcepto_keyDownHandler(event)"
																		dataProvider="{ outerDocument.conceptos }" matchType="anyPart" selectedItemStyleName="underline" allowMultipleSelection="false"
																		labelField="nombre" labelFunction="codigoNombreLabelFunction" backspaceAction="remove" allowNewValues="false"
																		dropDownWidth="460" dropDownRowCount="10" />
										</s:GridItemEditor>
									</fx:Component>
								</s:itemEditor>
								<s:itemRenderer>
									<fx:Component>
										<s:DefaultGridItemRenderer textAlign="left">
											<fx:Script>
												<![CDATA[
													override public function prepare(hasBeenRecycled:Boolean):void {
														if (!data) {
															return;
														}
														setStyle("color", "#100AB6");
														setStyle("fontWeight", "normal");
																										
														var conpto:String = data.conceptoIdLin ? data.conceptoIdLin : "";
														if (conpto) {
															label = conpto;
														}														
													}
												]]>
											</fx:Script>
										</s:DefaultGridItemRenderer>
									</fx:Component>
								</s:itemRenderer>
							</s:GridColumn>
							
							<s:GridColumn dataField="concepto" resizable="false" headerText="DESCRIPCIÓN" editable="{hasPermEdition()}">
								<s:itemRenderer>
									<fx:Component>
										<s:DefaultGridItemRenderer textAlign="left" verticalCenter="0" percentWidth="100">
											<fx:Script>
												<![CDATA[
													import biz.fulltime.model.LineaDocumento;
													
													import com.adobe.utils.StringUtil;
													
													override public function prepare(hasBeenRecycled:Boolean):void {
														if (!data) {
															return;
														}
														
														var linea:LineaDocumento = LineaDocumento(data);
														label = linea && linea.getConcepto() != null ? StringUtil.trim(linea.getConcepto()) : "";
														
													}
												]]>
											</fx:Script>
										</s:DefaultGridItemRenderer>
									</fx:Component>
								</s:itemRenderer>
								
								<s:itemEditor>
									<fx:Component>
										<s:DefaultGridItemEditor>
											<fx:Script>
												<![CDATA[
													import spark.components.DataGrid;
													
													override protected function keyDownHandler(event:KeyboardEvent):void {
														if ((value as String).length >= 50) {
															event.preventDefault();
														}
														if (event.keyCode == Keyboard.F1 || event.keyCode == Keyboard.F2) {
															DataGrid(owner).endItemEditorSession();
														}
														
													}
												]]>
											</fx:Script>
										</s:DefaultGridItemEditor>
									</fx:Component>
								</s:itemEditor>
							</s:GridColumn>

							<s:GridColumn width="100" dataField="precio" headerText="P. UNITARIO" editable="{hasPermEdition() || GeneralOptions.getInstance().loggedUser.esSupervisor()}" itemEditor="biz.fulltime.ui.forms.DGNumberEditor">
								<s:itemRenderer>
									<fx:Component>
										<s:DefaultGridItemRenderer textAlign="right">
											<fx:Script>
												<![CDATA[
													import biz.fulltime.model.LineaDocumento;
													
													override public function prepare(hasBeenRecycled:Boolean):void {
														if (!data) {
															return;
														}
														label = outerDocument.nf_Espanol_Espanol.format(LineaDocumento(data).getPrecio());
													}
												]]>
											</fx:Script>
										</s:DefaultGridItemRenderer>
									</fx:Component>
								</s:itemRenderer>
							</s:GridColumn>			
								
							
							<s:GridColumn width="100" headerText="SUBTOTAL" editable="false">
								<s:itemRenderer>
									<fx:Component>
										<s:DefaultGridItemRenderer textAlign="right">
											<fx:Script>
												<![CDATA[
													import biz.fulltime.model.LineaDocumento;
													
													override public function prepare(hasBeenRecycled:Boolean):void {
														if (!data) {
															return;
														}
														var importe:BigDecimal = LineaDocumento(data).getSubTotal();
														
														label = outerDocument.nf_Espanol_Espanol.format(importe);
													}
												]]>
											</fx:Script>
										</s:DefaultGridItemRenderer>
									</fx:Component>
								</s:itemRenderer>
							</s:GridColumn>
							
							<s:GridColumn width="145" headerText="TIPO IVA" editable="true" visible="{!documento.comprobante.aster &amp;&amp; !documento.comprobante.exento}">
								<s:itemRenderer>
									<fx:Component>
										<s:DefaultGridItemRenderer textAlign="right">
											<fx:Script>
												<![CDATA[
													import biz.fulltime.model.Iva;
													import biz.fulltime.model.LineaDocumento;
													
													import util.CatalogoFactory;
													
													override public function prepare(hasBeenRecycled:Boolean):void {
														if (!data) {
															return;
														}														
														 
														label = "[exento]";
														for each(var iva:Iva in CatalogoFactory.getInstance().ivas) {
															if (LineaDocumento(data).ivaLin && iva.codigo == LineaDocumento(data).ivaLin.codigo) {
																label = iva.nombre;
																break;
															}																
														}					
														
													}
												]]>
											</fx:Script>
										</s:DefaultGridItemRenderer>
									</fx:Component>
								</s:itemRenderer>
								<s:itemEditor>
									<fx:Component>
										<s:GridItemEditor>
											<fx:Script>
												<![CDATA[
													import biz.fulltime.model.Iva;
													import biz.fulltime.model.LineaDocumento;
													
													import mx.collections.ArrayCollection;
													import mx.events.FlexEvent;
													import mx.utils.StringUtil;
													
													import spark.components.DataGrid;
													
													import util.CatalogoFactory;
													
													[Bindable]
													var selectedIva:Iva = null;
																										
													override public function get value():Object {
														if (acIva.selectedItem.codigo == "") {
															return null;
														}
														return acIva.selectedItem;
													}
													
													override public function set value(newValue:Object):void {
														acIva.selectedItem = newValue;
													}
																																						
																										
													protected function acIva_creationCompleteHandler(event:FlexEvent):void {
														callLater(function():void {
															acIva.textInput.setFocus();
														});

														var iva:Iva = new Iva();
														iva.codigo = "0";
														iva.nombre = "[exento]";

														var options:ArrayCollection = new ArrayCollection();
														options.addItem(iva);
														
														for each(var iva:Iva in CatalogoFactory.getInstance().ivas) {
															if (iva.codigo == "3" || iva.codigo == "4") {
																options.addItem(iva);
															}																
														}													
														
														acIva.dataProvider = options;

														var currentIva:String = LineaDocumento(data).ivaLin ? LineaDocumento(data).ivaLin.codigo : "0";
														
														if (currentIva) {
															for each(var iva:Iva in options) {
																if (currentIva == iva.codigo) {
																	selectedIva = iva;
																	break;
																}
															}
														}					
													}
													
													
													protected function acIva_changeHandler(event:Event):void {
														var iva:Iva = acIva.selectedItem as Iva;
														
														LineaDocumento(data).ivaLin = iva.codigo == "0" ? null : iva;
													}
													
												]]>
											</fx:Script>
											<components1:MyAutoComplete id="acIva" width="100%" height="100%" textAlign="left" change="acIva_changeHandler(event)"
																		creationComplete="acIva_creationCompleteHandler(event)" 
																		matchType="anyPart" allowMultipleSelection="false"
																		labelField="nombre" allowNewValues="false"
																		selectedItem="{selectedIva}"/>
										</s:GridItemEditor>
									</fx:Component>
								</s:itemEditor>
							</s:GridColumn>
							

							<s:GridColumn width="80" headerText="IVA" editable="false" visible="{!documento.comprobante.aster &amp;&amp; !documento.comprobante.exento}">
								<s:itemRenderer>
									<fx:Component>
										<s:DefaultGridItemRenderer textAlign="right">
											<fx:Script>
												<![CDATA[
													import biz.fulltime.model.LineaDocumento;
													
													override public function prepare(hasBeenRecycled:Boolean):void {
														if (!data) {
															return;
														}														
														if (LineaDocumento(data).comprobanteComputaIva()) {
															label = outerDocument.nf_Espanol_Espanol.format(LineaDocumento(data).getIva());
														} else {
															label = "";
														}
													}
												]]>
											</fx:Script>
										</s:DefaultGridItemRenderer>
									</fx:Component>
								</s:itemRenderer>
							</s:GridColumn>							
							
							
							<s:GridColumn width="100" headerText="TOTAL" editable="false">
								<s:itemRenderer>
									<fx:Component>
										<s:DefaultGridItemRenderer textAlign="right">
											<fx:Script>
												<![CDATA[
													import biz.fulltime.model.LineaDocumento;
													
													override public function prepare(hasBeenRecycled:Boolean):void {
														if (!data) {
															return;
														}														
														label = outerDocument.nf_Espanol_Espanol.format(LineaDocumento(data).getSubTotal().add(LineaDocumento(data).getIva()));
													}
												]]>
											</fx:Script>
										</s:DefaultGridItemRenderer>
									</fx:Component>
								</s:itemRenderer>
							</s:GridColumn>
							
							<s:GridColumn width="34" headerText="" rendererIsEditable="true" visible="{!documento.emitido || GeneralOptions.getInstance().loggedUser.esSupervisor() }">
								<s:itemRenderer>
									<fx:Component>
										<s:GridItemRenderer>
											<fx:Script>
												<![CDATA[
													import mx.controls.Alert;
													import mx.events.CloseEvent;
													
													protected function cmdRemove_clickHandler(event:MouseEvent):void {
														Alert.show("¿Esta usted seguro?", "Borrar gasto", Alert.YES + Alert.NO, null, myCloseHandler);
													}
													
													private function myCloseHandler(event:CloseEvent):void {
														if (event.detail == Alert.YES) {
															this.outerDocument.borrarLineaGasto();
														}
													}
												]]>
											</fx:Script>
											
											<s:VGroup width="100%" height="100%" horizontalAlign="center" paddingLeft="2" verticalAlign="middle" creationComplete="cmdRemove.setFocus()">
												<s:Button id="cmdRemove" width="100%" height="100%" icon="@Embed('/assets/general/trash.png')" click="cmdRemove_clickHandler(event)"
														  focusEnabled="false" toolTip="Borrar gasto" />
											</s:VGroup>
										</s:GridItemRenderer>
									</fx:Component>
								</s:itemRenderer>
							</s:GridColumn>
							
							<s:GridColumn width="34" headerText="" rendererIsEditable="true" visible="{!documento.emitido || GeneralOptions.getInstance().loggedUser.esSupervisor() }">
								<s:itemRenderer>
									<fx:Component>
										<s:GridItemRenderer>
											<fx:Script>
												<![CDATA[
													import biz.fulltime.model.LineaDocumento;
													
													protected function cmdNotas_clickHandler(event:MouseEvent):void {
														this.outerDocument.editarNotas(LineaDocumento(data));
													}
												]]>
											</fx:Script>
											
											<s:VGroup width="100%" height="100%" horizontalAlign="center" paddingLeft="2" verticalAlign="middle">
												<s:Button id="cmdNotas" width="100%" height="100%" icon="@Embed('/assets/general/notes.png')" click="cmdNotas_clickHandler(event)" focusEnabled="false" 
														  toolTip="Ver notas"/>
											</s:VGroup>
										</s:GridItemRenderer>
									</fx:Component>
								</s:itemRenderer>
							</s:GridColumn>
						</s:ArrayList>
					</s:columns>
				</s:DataGrid>
			</s:HGroup>
		</s:VGroup>
		
		<s:controlBarContent>
			<s:HGroup width="100%" horizontalAlign="right" paddingBottom="0" paddingTop="0">
				<mx:Image id="loader1" source="@Embed(source='assets/general/logo_oscuro.gif')" alpha=".5" scaleX=".25" scaleY=".25" />
				<s:Spacer width="100%" />
				<s:Button id="cmdAceptar" click="cmdAceptar_clickHandler(event)" label="Aceptar" styleName="aceptarButton" />
			</s:HGroup>
		</s:controlBarContent>
	</s:Panel>
	
</s:HGroup>
