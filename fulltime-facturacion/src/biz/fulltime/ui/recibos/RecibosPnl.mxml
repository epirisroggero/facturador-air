<?xml version="1.0" encoding="utf-8"?>
<s:Panel xmlns:classes="com.hillelcoren.components.autoComplete.classes.*" xmlns:componentes="componentes.*" xmlns:components="biz.fulltime.ui.components.*" xmlns:components1="components.*"
		 xmlns:fx="http://ns.adobe.com/mxml/2009" xmlns:loader="biz.fulltime.util.loader.*" xmlns:mx="library://ns.adobe.com/flex/mx" xmlns:recibocion="biz.fulltime.ui.recibocion.*"
		 xmlns:renderers="biz.fulltime.ui.renderers.*" xmlns:s="library://ns.adobe.com/flex/spark" xmlns:util="biz.fulltime.util.*"
		 width="100%" height="100%" backgroundAlpha="0.85" backgroundColor="0xfafafa" creationComplete="onCreationComplete(event)" initialize="initializeHandler(event)" enabled="{!running}">

	<fx:Script>
		<![CDATA[
			import biz.fulltime.conf.GeneralOptions;
			import biz.fulltime.conf.ServerConfig;
			import biz.fulltime.dto.DocumentoDTO;
			import biz.fulltime.dto.DocumentoQuery;
			import biz.fulltime.event.AbrirFacturaEvent;
			import biz.fulltime.event.ClienteEvent;
			import biz.fulltime.event.ListadoFacturasEvent;
			import biz.fulltime.model.Articulo;
			import biz.fulltime.model.Auditoria;
			import biz.fulltime.model.Cliente;
			import biz.fulltime.model.Comprobante;
			import biz.fulltime.model.CotizacionesModel;
			import biz.fulltime.model.CotizacionesMonedas;
			import biz.fulltime.model.Documento;
			import biz.fulltime.model.Iva;
			import biz.fulltime.model.LineaDocumento;
			import biz.fulltime.model.LineasDocumento;
			import biz.fulltime.model.Moneda;
			import biz.fulltime.model.SerieNumero;
			import biz.fulltime.model.VinculoDocumentos;
			import biz.fulltime.ui.components.HelpClientPnl;
			import biz.fulltime.ui.deudores.ListadoDeudoresCliente;
			import biz.fulltime.ui.documentosValores.FrmDocumentosValores;
			import biz.fulltime.ui.facturacion.FacturacionPnl;
			import biz.fulltime.ui.facturacion.FrmClaveSupervisora;
			import biz.fulltime.ui.forms.FrmLineasAuditoriaDoc;
			import biz.fulltime.ui.personas.ListadoFacturasPanel;
			
			import com.hillelcoren.components.AutoComplete;
			
			import mx.collections.ArrayCollection;
			import mx.controls.Alert;
			import mx.core.FlexGlobals;
			import mx.core.IFlexDisplayObject;
			import mx.events.CalendarLayoutChangeEvent;
			import mx.events.CloseEvent;
			import mx.events.DropdownEvent;
			import mx.events.FlexEvent;
			import mx.events.PropertyChangeEvent;
			import mx.formatters.DateFormatter;
			import mx.managers.ISystemManager;
			import mx.managers.PopUpManager;
			import mx.rpc.events.FaultEvent;
			import mx.rpc.events.ResultEvent;
			import mx.rpc.remoting.RemoteObject;
			
			import spark.components.TitleWindow;
			import spark.components.gridClasses.CellPosition;
			import spark.events.GridItemEditorEvent;
			import spark.events.IndexChangeEvent;
			import spark.events.TextOperationEvent;
			import spark.formatters.DateTimeFormatter;
			import spark.formatters.NumberFormatter;
			
			import util.CatalogoFactory;
			import util.DateUtil;
			import util.ErrorPanel;
			import util.Maths;

			[Bindable]
			[Embed("/assets/general/exclamation.png")]
			public var mediaIcon:Class;

			[Bindable]
			[Embed(source="assets/general/Info.png")]
			public var iconSymbol:Class;

			[Bindable]
			public var serieReciboList:ArrayCollection = new ArrayCollection([
				{value:"C", label:"C"}, 
				{value:"A", label:"A"},
				{value:"P", label:"P"}
			]);

			
			private var _recibo:Documento;

			private var remObjSave:RemoteObject;

			private var remObjModify:RemoteObject;

			private var remObjBorrar:RemoteObject;

			private var remObjEmitir:RemoteObject;

			private var helpWindow:TitleWindow;

			private var _changeRecibo:Boolean;

			private var notas:String;

			private var error:ErrorPanel;

			private const WINDOW_WIDTH:Number = 640;

			private const WINDOW_HEIGHT:Number = 600;

			[Bindable]
			private var _convirtiendo:Boolean = false;

			[Bindable]
			private var monedas:ArrayCollection = new ArrayCollection();

			[Bindable]
			private var running:Boolean = false;

			[Bindable]
			public var _modoVisualizacion:Boolean = false;

			[Bindable]
			public var tieneCambios:Boolean = false;

			[Bindable]
			public var tieneDescuentos:Boolean = false;

			[Bindable]
			public var tieneRF:Boolean = false;
			
			[Bindable]
			private var eMail:String;

			[Bindable]
			private var _usuarioAutorizante:String;

			[Bindable]
			private var tipoDoc:Object;

			[Bindable]
			private var saldoPendiente:BigDecimal = BigDecimal.ZERO;

			[Bindable]
			private var tieneVinculos:Boolean = false;

			[Bindable]
			private var monedasDistintas:Boolean = false;

			[Bindable]
			private var currentLine:VinculoDocumentos;

			private var emitiendo_recibo:Boolean = false;

			private var creando_nuevo:Boolean = false; 

			private var cellPos:CellPosition;
			
			private var addVinculosEnabled:Boolean = false;
			
			private var remFacturasCliente:RemoteObject;
			
			private var map:Dictionary = new Dictionary();
			
			[Bindable]
			private var serieSelected:Object;
			
			private var _changes:Boolean = false; 

			
			[Bindable]
			public var isAster:Boolean = false; 
			
			
			protected function cargarMonedas():void {
				monedas = new ArrayCollection();
				if (!isAster) { // Si es oficial el comprobante.
					for each (var m1:Moneda in CatalogoFactory.getInstance().monedas) {
						if (m1.nombre.indexOf("*") <= 0) {
							monedas.addItem(m1);
						}
					}
				} else {
					for each (var mda:Moneda in CatalogoFactory.getInstance().monedas) {
						if (mda.nombre.indexOf("*") > 0) {
							monedas.addItem(mda);
						}
					}
				}				
			}


			protected function initializeHandler(event:FlexEvent):void {
				// Guardar Documento
				remObjSave = new RemoteObject();
				remObjSave.destination = "CreatingRpc";
				remObjSave.channelSet = ServerConfig.getInstance().channelSet;
				remObjSave.addEventListener(ResultEvent.RESULT, resultSave);
				remObjSave.addEventListener(FaultEvent.FAULT, handleFault);
				remObjSave.showBusyCursor = true;

				// Modificar Documento
				remObjModify = new RemoteObject();
				remObjModify.destination = "CreatingRpc";
				remObjModify.channelSet = ServerConfig.getInstance().channelSet;
				remObjModify.addEventListener(ResultEvent.RESULT, resultModify);
				remObjModify.addEventListener(FaultEvent.FAULT, handleFault);
				remObjModify.showBusyCursor = true;

				// Borrar Documento
				remObjBorrar = new RemoteObject();
				remObjBorrar.destination = "CreatingRpc";
				remObjBorrar.channelSet = ServerConfig.getInstance().channelSet;
				remObjBorrar.addEventListener(ResultEvent.RESULT, resultBorrar);
				remObjBorrar.addEventListener(FaultEvent.FAULT, handleFault);
				remObjBorrar.showBusyCursor = true;

				// Emitir Documento
				remObjEmitir = new RemoteObject();
				remObjEmitir.destination = "CreatingRpc";
				remObjEmitir.channelSet = ServerConfig.getInstance().channelSet;
				remObjEmitir.addEventListener(ResultEvent.RESULT, resultEmitir);
				remObjEmitir.addEventListener(FaultEvent.FAULT, handleFault);
				remObjEmitir.showBusyCursor = true;

			}

			protected function onCreationComplete(event:FlexEvent):void {
				txtNumero.setFocus();

				if (CatalogoFactory.getInstance().parametrosAdministracion.parAdmFechaTrabado) {
					txtDate.disabledRanges = [{rangeEnd:CatalogoFactory.getInstance().parametrosAdministracion.parAdmFechaTrabado}];
				}
			}

			override protected function commitProperties():void {
				super.commitProperties();
				
				title = (tieneCambios ? "[*]" : "") + _recibo.comprobante.nombre.toUpperCase()

				if (_changeRecibo) {
					_changeRecibo = false;
					
					isAster = _recibo.comprobante.aster;
					
					tieneRF = _recibo.serie && _recibo.serie != "A" && _recibo.serie != "P";
					
					if (!_recibo.docRecNeto) {
						_recibo.docRecNeto = _recibo.total;
					}
					if (cmbMoney) {
						cmbMoney.clear();
					}

					// Si el comprobante no es aster, no mostrar las monedas aster. 
					cargarMonedas();
					
					if (!_recibo.docRecMda) {
						_recibo.docRecMda = _recibo.moneda;
					}

					_convirtiendo = false;

					// Setear el estado de la recibo
					this.currentState = "default";
					
					if (pnlFacturasVinculadas) {
						pnlFacturasVinculadas.enabled = _recibo.docId != null;
					}
					
					saldoPendiente = new BigDecimal(recibo.saldo);
					tieneVinculos = _recibo.tieneFaturasVincululadas();
					
					if (tieneVinculos) {
						var vinculo:VinculoDocumentos = _recibo.facturasVinculadas.getItemAt(0) as VinculoDocumentos;
						var doc:Documento = vinculo.factura;
						_recibo.moneda = doc.moneda;
						
						var facturasVinculadas:ArrayCollection = _recibo.facturasVinculadas;
						for each (var vin:VinculoDocumentos in facturasVinculadas) {
							var dscto:BigDecimal = vin.descuentoPorc ? new BigDecimal(vin.descuentoPorc) : BigDecimal.ZERO;
							var monto:BigDecimal = vin.monto ? new BigDecimal(vin.monto) : BigDecimal.ZERO;
							var neto:BigDecimal = vin.neto ? new BigDecimal(vin.neto) : null;
							
							if (!neto) {
								if (isAster) {
									neto = Maths.ONE_HUNDRED.subtract(dscto).multiply(monto).divideScaleRound(Maths.ONE_HUNDRED, 4, MathContext.ROUND_HALF_EVEN);
								}  else {
									neto = monto != null ? monto : BigDecimal.ZERO;
								}
							}
							
							vin.factura.saldo = new BigDecimal(vin.factura.saldo).setScale(4, MathContext.ROUND_HALF_EVEN).toString();
							
							if (!recibo.emitido) {						
								if (isAster) {
									vin.neto = neto.toString();
									vin.monto = monto.toString();
									if (vin.nuevo) {
										vin.factura.saldo = new BigDecimal(vin.factura.saldo).add(new BigDecimal(vin.monto)).setScale(4, MathContext.ROUND_HALF_EVEN).toString();
									} 
								} else {
									vin.neto = neto.toString();
									if (vin.nuevo) {
										vin.factura.saldo = new BigDecimal(vin.factura.saldo).add(new BigDecimal(vin.neto)).setScale(4, MathContext.ROUND_HALF_EVEN).toString();
									}									
								}
							} 
							
							if (isAster) {
								// Calcular el monto de descuento.
								var montoDto:BigDecimal = BigDecimal.ZERO;
								if ((Maths.ONE_HUNDRED.subtract(dscto.setScale(2, MathContext.ROUND_HALF_EVEN))).compareTo(BigDecimal.ZERO) != 0) { 
									montoDto = monto.multiply(dscto.setScale(2, MathContext.ROUND_HALF_EVEN)).divideScaleRound(Maths.ONE_HUNDRED, 2, MathContext.ROUND_HALF_EVEN);
								}
								vin.descuentoMonto = montoDto.toString();							
								
							} else {
								// Calcular el monto cancelado.
								vin.monto = vin.calcularMontoCancelado(dscto, null, neto, false).setScale(4, MathContext.ROUND_HALF_EVEN).toString();
								
								// Calcular el monto de descuento.
								vin.descuentoMonto = vin.calcularMontoDescuento(null, dscto, neto, isAster).setScale(4, MathContext.ROUND_HALF_EVEN).toString();
								
							}
						}						
						
						var netoTotal:BigDecimal = getNetoTotal();
						var montoTotal:BigDecimal = getMontoTotal();
						var desctoTotal:BigDecimal = getDescuentoTotal();
						var rentaTotal:BigDecimal = getRentaTotal();
						
						actualizarTotales(netoTotal, montoTotal, desctoTotal, rentaTotal);
					} 
					
					// Ponerle el titulo del recibo					
					title = _recibo.comprobante.nombre.toUpperCase();

					// Actualizar campo de cotizacion comercial.
					if (!_recibo.docTCC || new BigDecimal(_recibo.docTCC).compareTo(BigDecimal.ZERO) <= 0) {
						if (CatalogoFactory.getInstance().ultimaCotizacion) {
							_recibo.docTCC = new BigDecimal(CatalogoFactory.getInstance().ultimaCotizacion.toString()).setScale(4, MathContext.ROUND_HALF_EVEN).toString();
						} else {
							obtenerTipoCambio();
						}
					} else {
						_recibo.docTCC = new BigDecimal(_recibo.docTCC).setScale(4, MathContext.ROUND_HALF_EVEN).toString();
					}
					
					if (_recibo.docId != null) {
						callLater(function():void {
							obtenerFacturas("ASC");
							if (_recibo.facturasVinculadas.length < 1) {
								agregarVinculoVacio();	
							}
						});
					}

					// Los vendedores (junior, distribuidor, senior) solo pueden editar documentos que ellos crearon (Documento.usuarioId). 
					// Si no son creadores, entonces el documento aparece para solo lectura. 
					// Administradores y Supervisores pueden editar cualquier cosa.
					if (_recibo.nuevo) {
						_modoVisualizacion = false;
					} else {
						if (CatalogoFactory.getInstance().parametrosAdministracion.parAdmFechaTrabado && (DateUtil.compareDates(_recibo.fechaDoc, CatalogoFactory.getInstance().parametrosAdministracion.parAdmFechaTrabado) == -1)) {
							_modoVisualizacion = true;
						} else {
							_modoVisualizacion = !_recibo.permisosDocumentoUsuario.edicion;
						}
					}

					if (_recibo && _recibo.cliente) {
						_recibo.getDepartamento();
					}
					
					_recibo.addEventListener(PropertyChangeEvent.PROPERTY_CHANGE, function(evt:PropertyChangeEvent):void {
							tieneCambios = true;
							invalidateProperties();
						});
					
					serieReciboList.removeAll();
					if (_recibo.comprobante.codigo != "32") { 
						serieReciboList.addItem({value:"C", label:"C"});
					}
					if (!isAster || _recibo.comprobante.codigo == "32") {
						serieReciboList.addItem({value:"A", label:"A"});
					}
					serieReciboList.addItem({value:"P", label:"P"});

					callLater(function():void {
						tieneCambios = false;
						
						serieSelected = serieReciboList.getItemAt(0);
						if (!_recibo.docId) { // Recibo nuevo
							if (txtNumero) {
								txtNumero.setFocus();
							}
							_recibo.serie = serieSelected.value;

						} else {
							if (dgVinculos && dgVinculos.dataProvider.length > 0) {
								dgVinculos.setFocus();
								dgVinculos.setSelectedCell(0, 0);	
							}
							if (!_recibo.serie) {
								_recibo.serie = serieSelected.value;
							}
							for each (var o:Object in serieReciboList)  {
								if (o.value == recibo.serie) {
									serieSelected = o;
								}
							}
						}
						
					});
					
				}
				
				// Verificar monedas
				if (recibo.docRecMda && recibo.moneda) {					
					monedasDistintas = recibo.docRecMda.codigo != recibo.moneda.codigo;
				} else {
					monedasDistintas = false;
				}
			}

			private function resultModify(event:ResultEvent):void {
				if (emitiendo_recibo) {
					recibo = event.result as Documento;
					running = true;
					
					// Emitir recibo si este no esta emitido
					if (!recibo.emitido) {
						recibo.emitidoPor = GeneralOptions.getInstance().loggedUser.codigo;
						remObjEmitir.emitir(recibo, "");
					}
				} else if (creando_nuevo) {
					creando_nuevo = false;
					tieneCambios = false;
					running = false;
					
				} else {
					resultGuardarRecibo(event);
				}
				
			}

			protected function cmdGuardar_clickHandler(event:MouseEvent, close:Boolean = false):void {
				var monto:String = "";
				
				try {
					var valor:BigDecimal = new BigDecimal(_recibo.docRecNeto);
					if (valor.compareTo(BigDecimal.ZERO) <= 0) {
						_recibo.docRecNeto = "";
					} else {
						_recibo.docRecNeto = valor.setScale(2).toString();
					}
					monto = _recibo.docRecNeto;
					
				} catch (error:Error) {
					_recibo.docRecNeto = "";
				}
				
				var alert:Alert;
				if (!_recibo.numero || recibo.numero.length == 0) {
					alert = Alert.show("El número no puede ser vacio.", "Error");
					alert.width = 400;
					alert.height = 200;
					
					txtNumero.setFocus();
					txtNumero.selectAll();
					return;
				}
				if (!_recibo.cliente) {
					alert = Alert.show("Debe seleccionar cliente.", "Error");
					alert.width = 400;
					alert.height = 200;
					
					cmbClient.setFocus();
					return;
				}
				if (monto.length == 0) {
					alert = Alert.show("El monto debe ser mayor a cero.", "Error");
					alert.width = 400;
					alert.height = 200;
					
					txtTotal.setFocus();
					return;
				}
				
				guardarRecibo();
				
			}

			private function grabarFacturaOk(close:Boolean = false):void {
				// Guardar la recibo.
				var remObj:RemoteObject = new RemoteObject();
				remObj.destination = "CreatingRpc";
				remObj.channelSet = ServerConfig.getInstance().channelSet;
				remObj.addEventListener(ResultEvent.RESULT, resultGuardarRecibo);
				remObj.addEventListener(FaultEvent.FAULT, handleFault);
				remObj.showBusyCursor = true;

				remObj.guardarDocumento(_recibo);
			}

			private function resultGuardarRecibo(event:ResultEvent):void {
				recibo = event.result as Documento;
				
				if (emitiendo_recibo) {
					running = true;
					
					if (!recibo.emitido) {
						recibo.emitidoPor = GeneralOptions.getInstance().loggedUser.codigo;
						remObjEmitir.emitir(recibo, "");
					}
					return;
				}
				error = new ErrorPanel();
				error.cornerRadius = 10;
				error.backgroundAlpha = .95;
				error.showButtons = false;
				error.type = 2;

				error.errorText = "El recibo ha sido GUARDADO.";

				PopUpManager.addPopUp(error, this, true);
				PopUpManager.centerPopUp(error);

				tieneCambios = false;
				running = false;
				invalidateProperties();

				setTimeout(function():void {
						PopUpManager.removePopUp(error);
					}, 1500);
			}


			private function reloadDocumento(docId:String, saving:Boolean = false):void {
				var remObj:RemoteObject = new RemoteObject();
				remObj.destination = "CreatingRpc";
				remObj.channelSet = ServerConfig.getInstance().channelSet;
				remObj.addEventListener(FaultEvent.FAULT, handleFault);
				remObj.addEventListener(ResultEvent.RESULT, function(evt:ResultEvent):void {
						recibo = evt.result as Documento;
						running = false;
						tieneCambios = false;						
						currentState = "default";
						invalidateProperties();
					});
				remObj.getDocumento(docId);
			}


			private function obtenerClaveSupervisora(result:Function):void {
				if (helpWindow == null) {
					helpWindow = new TitleWindow();
					helpWindow.title = "Ingrese clave supervisora";
					helpWindow.width = 400;
					helpWindow.height = 220;

					var frmClaveSup:FrmClaveSupervisora = new FrmClaveSupervisora();

					PopUpManager.addPopUp(helpWindow, this, true);
					PopUpManager.centerPopUp(helpWindow);

					helpWindow.addEventListener(CloseEvent.CLOSE, cs_closeHandler);
					frmClaveSup.addEventListener(CloseEvent.CLOSE, cs_closeHandler);
					frmClaveSup.addEventListener("_claveSupOK", result);
					helpWindow.addElement(frmClaveSup);
				}

			}

			private function handleFault(event:FaultEvent):void {
				var message:String = event.fault && event.fault.rootCause && event.fault.rootCause.cause ? event.fault.rootCause.cause.localizedMessage : null;
				if (!message) {
					message = event.message.toString();
				}				
				Alert.show(message, "Error", 4, null, null, StyleManager.getStyleManager(null).getStyleDeclaration('.icons32').getStyle('ErrorIcon'));

				emitiendo_recibo = false;
				running = false;
				creando_nuevo = false
				
				
				_convirtiendo = false;
				currentState = "default";
			}

			public function clear():void {
				if (cmbClient) {
					cmbClient.clear();
				}
			}

			[Bindable]
			public function get recibo():Documento {
				return _recibo;
			}

			public function set recibo(value:Documento):void {
				clear();

				_recibo = value;

				if (!_recibo.facturasVinculadas) {
					_recibo.facturasVinculadas = new ArrayCollection();
				}
				_changeRecibo = true;
				dispatchEvent(new Event("_changeDocumento"));
				invalidateProperties();
			}

			private function resultSerieNumero(event:ResultEvent):void {
				var serie:SerieNumero = event.result as SerieNumero;
				if (serie) {
					_recibo.serie = serie.serie;
					_recibo.numero = serie.numero;
				}
			}

			private function capture_keyDownHandlerCliente(event:KeyboardEvent):void {
				if (event.keyCode == Keyboard.F1) {
					cmbClient_helpFTHandler();
				}
			}

			//
			// Seleccion de Cliente
			// 
			protected function cmbClient_helpFTHandler(event:Event = null):void {
				if (helpWindow == null) {
					helpWindow = new TitleWindow();
					helpWindow.title = "Clientes";
					helpWindow.width = 840;
					helpWindow.height = 620;

					var hlpPanel:HelpClientPnl = new HelpClientPnl();

					PopUpManager.addPopUp(helpWindow, this, true);
					PopUpManager.centerPopUp(helpWindow);

					helpWindow.addEventListener(CloseEvent.CLOSE, cliente_closeHandler);
					hlpPanel.addEventListener(CloseEvent.CLOSE, cliente_closeHandler);
					hlpPanel.addEventListener(ClienteEvent.CLIENTE_SELECCIONADO, clienteSeleccionado);

					helpWindow.addElement(hlpPanel);
				}
			}

			private function clienteSeleccionado(event:ClienteEvent):void {
				helpWindow.removeEventListener(CloseEvent.CLOSE, cliente_closeHandler);
				PopUpManager.removePopUp(helpWindow as IFlexDisplayObject);

				var cliente:Cliente = event.cliente;
				cmbClient.selectedItem = cliente;

				//
				// Cargar datos del Cliente.
				//
				if (cliente != null) {
					_recibo.tomarCamposDelCliente(cliente.codigo);
				}
				helpWindow = null;

				callLater(function():void {
						cmbClient.setFocus();
					});
			}

			private function cliente_closeHandler(event:Event):void {
				helpWindow.removeEventListener(CloseEvent.CLOSE, cliente_closeHandler);
				PopUpManager.removePopUp(helpWindow as IFlexDisplayObject);
				helpWindow = null;

				callLater(function():void {
						cmbClient.setFocus();
					});
			}

			private function confirm_closeHandler(event:Event):void {
				helpWindow.removeEventListener(CloseEvent.CLOSE, confirm_closeHandler);
				PopUpManager.removePopUp(helpWindow as IFlexDisplayObject);
				helpWindow = null;
			}

			private function guardarRecibo(auditoria:Auditoria = null):void {
				tieneCambios = false;
				running = true;

				_recibo.planPagos = null;
				_recibo.cuotasDocumento.cuotas = new ArrayCollection();
				_recibo.lineas.lineas = new ArrayCollection();
				
				// Agregar linea en tabla de pagos
				if (_recibo.docId) {
					_recibo.establecerFormaPago();				
				}
				
				if (!_recibo.saldo) {
					_recibo.saldo = _recibo.docRecNeto;
				}
				
				var aux:ArrayCollection = new ArrayCollection();
				var facturasVinculadas:ArrayCollection = _recibo.facturasVinculadas;
				for each (var vinculo:VinculoDocumentos in facturasVinculadas) {
					if (vinculo.docIdVin1 && vinculo.docIdVin2) {
						aux.addItem(vinculo);
					}
				}
				recibo.facturasVinculadas = aux;

				// guardar errores para auditoría
				if (_recibo.nuevo) {
					remObjSave.alta(_recibo, auditoria);
				} else {
					remObjModify.modificar(_recibo, auditoria);
				}
				
				invalidateProperties();

			}

			private function closeHandler(event:Event):void {
				var ttlWnd:TitleWindow = event.target as TitleWindow;
				ttlWnd.removeEventListener(CloseEvent.CLOSE, closeHandler);
				PopUpManager.removePopUp(ttlWnd as IFlexDisplayObject);
			}


			private function resultSave(event:ResultEvent):void {
				var docId:String = event.result as String;
				if (!docId) {
					Alert.show("No se grabó correctamente el recibo", "Error");
					return;
				}
				error = new ErrorPanel();
				error.cornerRadius = 10;
				error.backgroundAlpha = .95;
				error.showButtons = false;
				error.type = 2;

				error.errorText = "RECIBO GUARDADO.";

				PopUpManager.addPopUp(error, this, true);
				PopUpManager.centerPopUp(error);

				setTimeout(function():void {
						PopUpManager.removePopUp(error);
					}, 1500);

				_recibo.docId = docId;

				recibo.nuevo = false;
				tieneCambios = false;

				reloadDocumento(docId, true);

			}

			protected function cmdCancel_clickHandler(event:MouseEvent):void {
				if (tieneCambios && _recibo.permisosDocumentoUsuario.edicion && !_modoVisualizacion) {
					Alert.buttonWidth = 80;
					var alert:Alert = Alert.show("El recibo ha sido modificado.\n¿Desea guardar los cambios?", "Guardar", Alert.YES + Alert.NO + Alert.CANCEL, null, confirmCloseHandler, iconSymbol);
					alert.width = 400;
					alert.height = 200;
				} else {
					dispatchEvent(new Event("_cancel_", true, true));
				}

			}

			protected function confirmCloseHandler(eventObj:CloseEvent):void {
				if (eventObj.detail == Alert.YES) {
					grabarFacturaOk(true);
				} else if (eventObj.detail == Alert.NO) {
					tieneCambios = false; // Se perderan los cambios
					invalidateProperties();
					dispatchEvent(new Event("_cancel_", true, true));
				}

			}

			public function codigoNombreLabelFunction(item:Object):String {
				var label:String = "";
				if (item && item.hasOwnProperty("codigo")) {
					label = item.codigo;
				}
				if (item && item.hasOwnProperty("nombre")) {
					label += " - " + item.nombre;
				}
				
				return label.toUpperCase();
			}

			public function clienteLabelFunction(item:Object):String {
				var client:Cliente = item as Cliente;

				var label:String;
				if (item && item.hasOwnProperty("codigo")) {
					label = item.codigo;
				}
				if (item && item.hasOwnProperty("nombre")) {
					label += " - " + item.nombre;
				}
				if (client && client.razonSocial != client.nombre) {
					label += " [" + client.razonSocial + "] ";
				}

				return label;
			}

			protected function cmbClient_changeHandler(event:Event):void {
				var cliente:Cliente = cmbClient.selectedItem;

				// Datos que vienen del cliente
				if (cliente && _recibo) {
					_recibo.tomarCamposDelCliente(cliente.codigo);
				}
			}

			private function cs_closeHandler(event:Event):void {
				helpWindow.removeEventListener(CloseEvent.CLOSE, cs_closeHandler);
				PopUpManager.removePopUp(helpWindow as IFlexDisplayObject);
				helpWindow = null;
			}

			private function resultBorrar(event:ResultEvent):void {
				dispatchEvent(new Event("_cancel_"));
			}

			protected function txtComments_keyDownHandler(event:KeyboardEvent):void {
				tieneCambios = true;
				invalidateProperties();
			}

			protected function cmdBorrar_clickHandler(event:MouseEvent):void {
				var alert:Alert = Alert.show("¿Esta seguro de BORRAR el recibo?", "Borrar recibo", Alert.YES | Alert.NO, this, alertBorrarClickHandler, mediaIcon);
				alert.width = 400;
				alert.height = 200;
			}

			// Event handler function for displaying the selected Alert button.
			private function alertBorrarClickHandler(evt:CloseEvent):void {
				if (evt.detail == Alert.YES) {
					remObjBorrar.baja(_recibo);
				}
			}

			protected function cmdNuevo_clickHandler(event:MouseEvent):void {
				creando_nuevo = true;
				
				var t:BigDecimal = new BigDecimal(_recibo.docRecNeto);
				if (_recibo.cliente != null && t.compareTo(BigDecimal.ZERO) > 0) {
					guardarRecibo();
				} 
				dispatchEvent(new Event("_nuevo_recibo"));

			}

			private function obtenerTipoCambio():void {
				var remObjCotizaciones:RemoteObject = new RemoteObject();
				remObjCotizaciones.destination = "CreatingRpc";
				remObjCotizaciones.channelSet = ServerConfig.getInstance().channelSet;
				remObjCotizaciones.addEventListener(ResultEvent.RESULT, resultCotizaciones);
				remObjCotizaciones.addEventListener(FaultEvent.FAULT, function(evt:FaultEvent):void {
						Alert.show(evt.fault.faultString, "Advertencia");
					});
				remObjCotizaciones.getCotizacionHoy();
			}

			private function resultCotizaciones(event:ResultEvent):void {
				var result:CotizacionesMonedas = event.result as CotizacionesMonedas;

				var dolarCompra:BigDecimal = new BigDecimal(result.dolarCompra);
				var dolarVenta:BigDecimal = new BigDecimal(result.dolarVenta);
				var euroCompra:BigDecimal = new BigDecimal(result.euroCompra);
				var euroVenta:BigDecimal = new BigDecimal(result.euroVenta);

				var formatter:DateFormatter = new DateFormatter();
				formatter.formatString = 'DD-MM-YYYY';

				var _cotizaciones:XML =
					<cotizaciones>
						<fecha/>
						<dolarCompra value="0.0"/>
						<dolarVenta value="0.0"/>
						<euroCompra value="0.0"/>
						<euroVenta value="0.0"/>
						<euroCompraXDolar value="0.0"/>
						<euroVentaXDolar value="0.0"/>
					</cotizaciones>
					;

				_cotizaciones.fecha.@value = formatter.format(result.dia);
				_cotizaciones.dolarCompra.@value = dolarCompra.setScale(2, MathContext.ROUND_HALF_EVEN).toString();
				_cotizaciones.dolarVenta.@value = dolarVenta.setScale(2, MathContext.ROUND_UP).toString();
				_cotizaciones.euroCompra.@value = euroCompra.setScale(2, MathContext.ROUND_HALF_EVEN).toString();
				_cotizaciones.euroVenta.@value = euroVenta.setScale(2, MathContext.ROUND_UP).toString();
				_cotizaciones.euroCompraXDolar.@value = euroCompra.divideScaleRound(dolarCompra, 2, MathContext.ROUND_HALF_EVEN).toString();
				_cotizaciones.euroVentaXDolar.@value = euroVenta.divideScaleRound(dolarVenta, 2, MathContext.ROUND_UP).toString();

				CotizacionesModel.getInstance().cotizaciones = _cotizaciones;

				if (_recibo) {
					_recibo.docTCC = _cotizaciones.dolarVenta.@value;
				}
			}

			protected function txtRUT_changeHandler(event:TextOperationEvent):void {
				var value:String = txtRUT.text;
				if (value.length == 0 || value.length >= 12) {
					rut_stringValidator.validate();
				}
			}

			protected function cmdAgregar_clickHandler(event:MouseEvent = null):void {
				var cliente:Cliente = recibo.cliente;

				if (!cliente) {
					var alert:Alert = Alert.show("Cliente inexistente.", "Error");
					alert.width = 400;
					alert.height = 200;
					return;
				}
				var facPendWindow:TitleWindow = new TitleWindow();
				facPendWindow.title = "Facturas: " + cliente.nombre;
				facPendWindow.width = 920;
				facPendWindow.height = 640;
				facPendWindow.addEventListener(CloseEvent.CLOSE, function(event:CloseEvent):void {
						PopUpManager.removePopUp(facPendWindow as IFlexDisplayObject);
						facPendWindow = null;
					});

				var frmFacturas:ListadoFacturasPanel = new ListadoFacturasPanel();
				frmFacturas.filtros = recibo.facturasVinculadas;
				frmFacturas.cliente = cliente;
				frmFacturas.seleccionMultiple = true;
				frmFacturas.moneda = cmbMonedaVinculos.selectedItem as Moneda;
				frmFacturas.showCliente = false;
				frmFacturas.hasSaldoPendiente = true;
				frmFacturas.documentos = new ArrayCollection();
				
				
				var comprobantes:String = "2,4,5,6,7,8,9,19,20,22,98"; 
				if (isAster) { // RECIBOS ASTER
					if (recibo.serie == "C") {
						comprobantes = "4";
					}  
				} else { // RECIBOS OFICIALES
					if (recibo.serie == "A") {
						comprobantes = "7";
					} else if(recibo.serie == "C") {
						comprobantes = "9";
					} 
				}
				frmFacturas.obtenerFacturasVinculadas("ASC", comprobantes);

				PopUpManager.addPopUp(facPendWindow, Sprite(FlexGlobals.topLevelApplication), true);
				PopUpManager.centerPopUp(facPendWindow);

				frmFacturas.addEventListener(CloseEvent.CLOSE, function(evt:CloseEvent):void {
						PopUpManager.removePopUp(facPendWindow as IFlexDisplayObject);
						facPendWindow = null;
					});
				
				frmFacturas.addEventListener(ListadoFacturasEvent.FACTURAS_SELECTED, function(event:ListadoFacturasEvent):void {
					var facturas:Vector.<Object> = event.facturas as Vector.<Object>;
					
					for each (var doc:Object in facturas) {
						var factura:DocumentoDTO = doc as DocumentoDTO;
						
						if (factura != null) {
							var remObj:RemoteObject = new RemoteObject();
							remObj.destination = "CreatingRpc";
							remObj.channelSet = ServerConfig.getInstance().channelSet;
							remObj.addEventListener(FaultEvent.FAULT, handleFault);
							remObj.addEventListener(ResultEvent.RESULT, function(evt:ResultEvent):void {
								var doc:Documento = evt.result as Documento;
								
								var vinculo:VinculoDocumentos = null;
								if (!event) {
									var rowIndex:int = dgVinculos.selectedCell.rowIndex;
									vinculo = (VinculoDocumentos) (recibo.facturasVinculadas.getItemAt(rowIndex)); 
									
									var ajusteS:BigDecimal;
									//if (isAster) {
									ajusteS = vinculo.neto && vinculo.neto.length > 0 ? new BigDecimal(vinculo.neto) : BigDecimal.ZERO;
									//} else {
									//	ajusteS = vinculo.monto && vinculo.monto.length > 0 ? new BigDecimal(vinculo.monto) : BigDecimal.ZERO;
									//}
									ajusteS = recibo.convertirMoneda(recibo.moneda, recibo.docRecMda, ajusteS);
									saldoPendiente = saldoPendiente.add(ajusteS);
								}
								
								vinculo = agregarVinculo(doc);
								
								running = false;
								currentState = "default";
								
								if (event) {
									var toRemove:ArrayCollection = new ArrayCollection();
									for each (var vinculo1:VinculoDocumentos in recibo.facturasVinculadas) {
										if (!vinculo1.factura.numero) {
											toRemove.addItem(vinculo1);
										}
									}
									for each (var vRemove:VinculoDocumentos in toRemove) {
										recibo.facturasVinculadas.removeItemAt(recibo.facturasVinculadas.getItemIndex(vRemove));
									}
									recibo.facturasVinculadas.addItem(vinculo);
								}
								updateTotalFacturasVinculadas();
								
								callLater(function():void {
									if (dgVinculos && dgVinculos.dataProvider.length > 0) {
										dgVinculos.setFocus();
										
										if (event) {
											dgVinculos.setSelectedCell(recibo.facturasVinculadas.length-1, 0);	
										}
									}
								});
							});
							remObj.getDocumento(factura.docId);
						}
					}

					PopUpManager.removePopUp(facPendWindow as IFlexDisplayObject);
					facPendWindow = null;
				}); 
					
				frmFacturas.addEventListener("facturaSeleccionada", function(evt:Event):void {
						var factura:DocumentoDTO = frmFacturas.selectedItem as DocumentoDTO;
						if (factura != null) {
							var remObj:RemoteObject = new RemoteObject();
							remObj.destination = "CreatingRpc";
							remObj.channelSet = ServerConfig.getInstance().channelSet;
							remObj.addEventListener(FaultEvent.FAULT, handleFault);
							remObj.addEventListener(ResultEvent.RESULT, function(evt:ResultEvent):void {
									var doc:Documento = evt.result as Documento;

									var vinculo:VinculoDocumentos = null;
									if (!event) {
										var rowIndex:int = dgVinculos.selectedCell.rowIndex;
										vinculo = (VinculoDocumentos) (recibo.facturasVinculadas.getItemAt(rowIndex)); 
										
										var ajusteS:BigDecimal;
										if (isAster) {
											ajusteS = vinculo.neto && vinculo.neto.length > 0 ? new BigDecimal(vinculo.neto) : BigDecimal.ZERO;
										} else {
											ajusteS = vinculo.monto && vinculo.monto.length > 0 ? new BigDecimal(vinculo.monto) : BigDecimal.ZERO;
										}
										ajusteS = recibo.convertirMoneda(recibo.moneda, recibo.docRecMda, ajusteS);
										saldoPendiente = saldoPendiente.add(ajusteS);
									} 
									
									vinculo = agregarVinculo(doc);
									
									running = false;
									currentState = "default";
									
									if (event) {
										var toRemove:ArrayCollection = new ArrayCollection();
										for each (var vinculo1:VinculoDocumentos in recibo.facturasVinculadas) {
											if (!vinculo1.factura.numero) {
												toRemove.addItem(vinculo1);
											}
										}
										for each (var vRemove:VinculoDocumentos in toRemove) {
											recibo.facturasVinculadas.removeItemAt(recibo.facturasVinculadas.getItemIndex(vRemove));
										}
										recibo.facturasVinculadas.addItem(vinculo);
									}
									updateTotalFacturasVinculadas();

									callLater(function():void {
										if (dgVinculos && dgVinculos.dataProvider.length > 0) {
											dgVinculos.setFocus();
											
											if (event) {
												dgVinculos.setSelectedCell(recibo.facturasVinculadas.length-1, 0);	
											}
										}
									});
									
								});
							remObj.getDocumento(factura.docId);

						}

						PopUpManager.removePopUp(facPendWindow as IFlexDisplayObject);
						facPendWindow = null;

					});

				facPendWindow.addElement(frmFacturas);

				facPendWindow.closeButton.visible = true;

			}

			protected function dgVinculos_creationCompleteHandler(event:FlexEvent):void {
				callLater(function():void {
					if (!_recibo.docId) {
						if (txtNumero) {
							txtNumero.setFocus();
						}
					} else {
						if (dgVinculos && dgVinculos.dataProvider.length > 0) {
							dgVinculos.setFocus();
							dgVinculos.setSelectedCell(0, 0);	
						}
					}
				});
			}

			protected function dgVinculos_gridItemEditorSessionSaveHandler(event:GridItemEditorEvent):void {
				var vinculo:VinculoDocumentos = recibo.facturasVinculadas.getItemAt(event.rowIndex) as VinculoDocumentos;
				var monto:BigDecimal = (vinculo.monto && vinculo.monto.length > 0) ? new BigDecimal(vinculo.monto) : BigDecimal.ZERO;
				var neto:BigDecimal = (vinculo.neto && vinculo.neto.length > 0) ? new BigDecimal(vinculo.neto) : BigDecimal.ZERO;

				var dataField:String = event.column.dataField;
								
				if (event.columnIndex == 0) {
					var serie:String = vinculo.factura.serie;
					var numero:String = vinculo.factura.numero;

					saldoPendiente = saldoPendiente.add(monto);

					var serieNumero:String = (serie != null ? serie : "") + (numero != null ? numero : "");
					
					var cociente:BigDecimal;
					var neto_:String;
					
					var factura:DocumentoDTO = map[serieNumero];
					if (factura) {
						var remObj:RemoteObject = new RemoteObject();
						remObj.destination = "CreatingRpc";
						remObj.channelSet = ServerConfig.getInstance().channelSet;
						remObj.addEventListener(FaultEvent.FAULT, handleFault);
						remObj.addEventListener(ResultEvent.RESULT, function(evt:ResultEvent):void {
							var doc:Documento = evt.result as Documento;
							
							var vinculo:VinculoDocumentos = new VinculoDocumentos();
							if (!event) {
								var rowIndex:int = dgVinculos.selectedCell.rowIndex;
								vinculo = (VinculoDocumentos) (recibo.facturasVinculadas.getItemAt(rowIndex)); 
								
								var monto:BigDecimal;
								if (isAster) {
									monto = vinculo.neto && vinculo.neto.length > 0 ? new BigDecimal(vinculo.neto) : BigDecimal.ZERO;
								} else {
									monto = vinculo.monto && vinculo.monto.length > 0 ? new BigDecimal(vinculo.monto) : BigDecimal.ZERO;
								}
								monto = recibo.convertirMoneda(recibo.moneda, recibo.docRecMda, monto);
								saldoPendiente = saldoPendiente.add(monto);
							} 
							
							vinculo = agregarVinculo(doc);
							
							updateTotalFacturasVinculadas();
						});

						remObj.getDocumento(factura.docId);
					}
					 
				} else {
					if (dataField == "descuentoPorc") {
						vinculo.cambioPorcDto(isAster);
					} else if (dataField == "descuentoMonto") {
						vinculo.cambioMontoDto(isAster);
					} else if (dataField == "neto") {
						vinculo.cambioMontoNeto(isAster);
					} else if (dataField == "monto") {
						vinculo.cambioMontoCancelado(isAster);
					} 

					vinculo.calcularRentaFinanciera(isAster, recibo.serie);
					updateTotalFacturasVinculadas();
				}
			}
			
			public function borrarVinculo():void {
				var rowIndex:int = dgVinculos.selectedCell.rowIndex;

				_recibo.facturasVinculadas.removeItemAt(rowIndex);
				dgVinculos.invalidateDisplayList();

				callLater(function():void {
					var maxIndex:int = dgVinculos.dataProvider.length - 1;
					if (dgVinculos.dataProvider.length >= 0) {
						if (rowIndex == 0) {
							dgVinculos.setSelectedCell(rowIndex, 0);
						} else if (rowIndex > maxIndex) {
							dgVinculos.setSelectedCell(maxIndex, 0);
						} else {
							dgVinculos.setSelectedCell(rowIndex, 0);
						}
					}
				});

				updateTotalFacturasVinculadas();

				tieneCambios = true;
				invalidateProperties();
			}

			private function date_labelFunction(item:Object, column:GridColumn):String {
				var vinculo:VinculoDocumentos = item as VinculoDocumentos;
				if (vinculo.factura) {
					var formatter:DateFormatter = new DateFormatter();
					formatter.formatString = "DD-MM-YYYY";
					return formatter.format(vinculo.factura.fechaDoc);
				}
				return "";
			}

			private function moneda_labelFunction(item:Object, column:GridColumn):String {
				var vinculo:VinculoDocumentos = item as VinculoDocumentos;
				if (vinculo.factura && vinculo.factura.moneda) {
					return vinculo.factura.moneda.nombre;
				}
				return "";
			}

			private function saldo_labelFunction(item:Object, column:GridColumn):String {
				var vinculo:VinculoDocumentos = item as VinculoDocumentos;
				if (vinculo.docIdVin1) {
					var saldo:BigDecimal = new BigDecimal(vinculo.factura.saldo).setScale(2, MathContext.ROUND_HALF_EVEN);
					return nf_Espanol_Espanol.format(saldo);
				} 
				return "";
			}
			
			private function total_labelFunction(item:Object, column:GridColumn):String {
				var vinculo:VinculoDocumentos = item as VinculoDocumentos;
				if (vinculo.docIdVin1) {
					var total:BigDecimal = new BigDecimal(vinculo.factura.total).setScale(2, MathContext.ROUND_HALF_EVEN);
					return nf_Espanol_Espanol.format(total);
				} 
				return "";
			}

			private function updateTotalFacturasVinculadas():void {
				dgVinculos.dataProvider = recibo.facturasVinculadas;
				
				var presicion:int = 2;
				
				var netoTotal:BigDecimal = getNetoTotal();
				var montoTotal:BigDecimal = getMontoTotal();
				var desctoTotal:BigDecimal = getDescuentoTotal();
				var rentaTotal:BigDecimal = getRentaTotal();
				
				var monedaRecibo:Moneda = recibo.docRecMda;
				var monedaVinculos:Moneda = recibo.moneda;

				var total:BigDecimal = recibo.getDocRecNeto();
				
				var canceladoTotalMdaVinculos:BigDecimal = isAster ? netoTotal : netoTotal;
				var canceladoTotalMdaRecibo:BigDecimal = recibo.convertirMoneda(monedaVinculos, monedaRecibo, canceladoTotalMdaVinculos);
				
				var pendienteMdaRecibo:BigDecimal = total.subtract(canceladoTotalMdaRecibo).setScale(4, MathContext.ROUND_HALF_EVEN);
				
				saldoPendiente = recibo.convertirMoneda(monedaRecibo, monedaVinculos, pendienteMdaRecibo).setScale(presicion, MathContext.ROUND_HALF_EVEN);
				
				tieneVinculos = recibo.tieneFaturasVincululadas();
				recibo.docVinculado = tieneVinculos ? "S" : "N";
				recibo.saldo = saldoPendiente ? saldoPendiente.toString() : BigDecimal.ZERO.toString();
				
				// En comprobantes aster calculo el descuento y porcentage de descuento.
				if (isAster) {
					var totalMdaVinculos:BigDecimal = netoTotal.add(desctoTotal);
					
					recibo.descuentos = desctoTotal.setScale(presicion, MathContext.ROUND_HALF_EVEN).toString();
					recibo.descuentosPorc = totalMdaVinculos.numberValue() > 0 ? desctoTotal.multiply(Maths.ONE_HUNDRED).divideRound(totalMdaVinculos, MathContext.ROUND_HALF_EVEN).toString() : "0.00";
					recibo.total = montoTotal.setScale(presicion, MathContext.ROUND_HALF_EVEN).toString();

				} else {
					recibo.descuentos = BigDecimal.ZERO.toString();
					recibo.descuentosPorc = BigDecimal.ZERO.toString();
				}

				recibo.docRenFin = rentaTotal.toString();
				
				actualizarTotales(netoTotal, montoTotal, desctoTotal, rentaTotal);
			}
			
			private function actualizarTotales(netoTotal:BigDecimal, montoTotal:BigDecimal, desctoTotal:BigDecimal, rentaTotal:BigDecimal):void {
				var monedaRecibo:Moneda = recibo.docRecMda;
				var monedaVinculos:Moneda = recibo.moneda;

				var montoNetoMdaRecibo:BigDecimal = recibo.convertirMoneda(monedaVinculos, monedaRecibo, netoTotal);
				var pendienteMdaRecibo:BigDecimal = recibo.convertirMoneda(monedaVinculos, monedaRecibo, saldoPendiente).setScale(2, MathContext.ROUND_HALF_EVEN);
				
				var buffer:String = "";
				buffer += "Total cancelado " + (monedaVinculos ? monedaVinculos.simbolo + " " : "") + nf_Espanol_Espanol.format(montoTotal.numberValue());
				buffer += " | Dto. " + (monedaVinculos ? monedaVinculos.simbolo + " " : "") + nf_Espanol_Espanol.format(desctoTotal.numberValue());
				
				if (isAster) { 
					buffer += " - " + nf_Espanol_Espanol.format(recibo.descuentosPorc) + "%";
					buffer += " | Neto " + (monedaVinculos ? monedaVinculos.simbolo + " " : "") + nf_Espanol_Espanol.format(netoTotal.numberValue()) + "";
				} else {
					buffer += " | Vinculado " + (monedaVinculos ? monedaVinculos.simbolo + " " : "") + nf_Espanol_Espanol.format( netoTotal.numberValue());
					if (monedaRecibo.codigo != monedaVinculos.codigo) {
						buffer += " (" + monedaRecibo.simbolo + " " +  nf_Espanol_Espanol.format(montoNetoMdaRecibo.numberValue()) + ")";
					}
				}
				
				if (tieneRF) {
					buffer += " | R.F. " + (monedaVinculos ? monedaVinculos.simbolo + " " : "") + nf_Espanol_Espanol.format(rentaTotal.numberValue());
				}
				
				if (monedaRecibo.codigo != monedaVinculos.codigo) {
					lblSaldoPendiente.text = "Saldo pendiente " + (monedaVinculos ? monedaVinculos.simbolo + " " : "") + nf_Espanol_Espanol.format(saldoPendiente.numberValue())
						+ " (" + monedaRecibo.simbolo + " " + nf_Espanol_Espanol.format(pendienteMdaRecibo.numberValue()) + ")";
				} else {
					lblSaldoPendiente.text = "Saldo pendiente " + (monedaVinculos ? monedaVinculos.simbolo + " " : "") + nf_Espanol_Espanol.format(saldoPendiente.numberValue());
				}
				
				lblMontoTotal.text = buffer;
				lblMontoTotal.setStyle("color", "#330000");
				
				tieneDescuentos = desctoTotal.numberValue() > 0;

			}
			
			protected function dgVinculos_keyDownHandler(event:KeyboardEvent):void {
				cellPos = dgVinculos.selectedCell;
				
				if (event.keyCode == Keyboard.ENTER) {
					var count:int = 0;
					var columns:ArrayCollection = new ArrayCollection(dgVinculos.columns.toArray());
					for each (var col:GridColumn in columns) {
						if (col.visible) {
							count++;
						}
					}
					var maxCol:int = columns.length - 2;
					var maxRow:int = dgVinculos.dataProvider.length - 1;

					var colIndex:int;
					var rowIndex:int;
					if (cellPos == null) {
						colIndex = dgVinculos.editorColumnIndex;
						rowIndex = dgVinculos.editorRowIndex
					} else {
						var i:int = 1;
						while (!columns[cellPos.columnIndex + i].visible) {
							i++;
						}
						colIndex = cellPos.columnIndex + i;
						rowIndex = cellPos.rowIndex;
					}
					if (colIndex > maxCol) {
						colIndex = 1;
						if (rowIndex == maxRow) {
							if (maxRow + 2 > 10) {
								var alert:Alert = Alert.show("Se pueden agregar un máximo de 10 vínculos.");
								alert.width = 400;
								alert.height = 200;

							} else {
								agregarVinculoVacio();
							}
						} else {
							rowIndex += 1;
							currentLine = dgVinculos.dataProvider.getItemAt(rowIndex) as VinculoDocumentos;
						}
					}
					dgVinculos.setSelectedCell(rowIndex, colIndex);
					
				} else if (event.keyCode == Keyboard.F1) { // Se presiono la tecla 'F1'
					if (!recibo.emitido) {
						cmdAgregar_clickHandler();
					}
					
					event.preventDefault();
					
				} else if ((event.keyCode >= Keyboard.A && event.keyCode <= Keyboard.Z) || (event.keyCode >= Keyboard.NUMBER_0 && event.keyCode <= Keyboard.NUMBER_9) || (event.keyCode >= Keyboard.NUMPAD_0 && event.keyCode <= Keyboard.NUMPAD_9) || event.keyCode == Keyboard.NUMPAD_DECIMAL || event.keyCode == Keyboard.PERIOD) {
					if ((dgVinculos.columns.getItemAt(cellPos.columnIndex) as GridColumn).editable) {
						dgVinculos.startItemEditorSession(cellPos.rowIndex, cellPos.columnIndex);
					}
				}
			}
			
			private function agregarVinculo(factura:Documento):VinculoDocumentos {
				var vinculo:VinculoDocumentos = new VinculoDocumentos();

				var monedaRecibo:Moneda = recibo.docRecMda;
				var monedaVinculos:Moneda = recibo.moneda; 
				
				var saldoPendienteMdaVinculos:BigDecimal = recibo.convertirMoneda(monedaRecibo, monedaVinculos, saldoPendiente);
				var totalFactura:BigDecimal = new BigDecimal(factura.total).setScale(4, MathContext.ROUND_HALF_EVEN);
				var saldoFactura:BigDecimal = new BigDecimal(factura.saldo).setScale(4, MathContext.ROUND_HALF_EVEN);
				
				var montoCancelado:BigDecimal = totalFactura.subtract(saldoFactura);
				var descuentoPorc:BigDecimal = factura.cuotasDocumento
					? factura.cuotasDocumento.calcularPorcentageDescuento(recibo.fechaDoc, montoCancelado, factura.cliente.categCliId)
					: BigDecimal.ZERO;
				
				vinculo.docIdVin1 = factura.docId;
				vinculo.docIdVin2 = recibo.docId;
				vinculo.factura = factura;
				vinculo.recibo = recibo;
				
				var descuento:BigDecimal = saldoFactura.multiply(descuentoPorc.divideScaleRound(Maths.ONE_HUNDRED, 4, MathContext.ROUND_HALF_EVEN));

				saldoFactura = saldoFactura.subtract(descuento);

				var montoNeto:BigDecimal = new BigDecimal(Math.min(saldoFactura.numberValue(), saldoPendienteMdaVinculos.numberValue()).toString());
				var montoDto:BigDecimal = vinculo.calcularMontoDescuento(null, descuentoPorc, montoNeto, isAster);
				var montoCancela:BigDecimal = vinculo.calcularMontoCancelado(null, montoDto, montoNeto, isAster);

/* 				if (isAster) {
					saldoFactura = saldoFactura.subtract(descuento);

					montoNeto = new BigDecimal(Math.min(saldoFactura.numberValue(), saldoPendienteMdaVinculos.numberValue()).toString());
					montoDto = vinculo.calcularMontoDescuento(null, descuentoPorc, montoNeto, isAster);
					montoCancela = vinculo.calcularMontoCancelado(null, montoDto, montoNeto, isAster);
				} else {
					saldoFactura = saldoFactura.subtract(descuento);
					
					montoNeto = new BigDecimal(Math.min(saldoFactura.numberValue(), saldoPendienteMdaVinculos.numberValue()).toString());
					montoDto = vinculo.calcularMontoDescuento(null, descuentoPorc, montoNeto, isAster);
					montoCancela = vinculo.calcularMontoCancelado(null, montoDto, montoNeto, isAster);
				}
 */				
				vinculo.descuentoPorc = descuentoPorc.setScale(2, MathContext.ROUND_HALF_EVEN).toString();
				vinculo.descuentoMonto = montoDto.toString();
				vinculo.neto = montoNeto.toString();
				vinculo.monto = montoCancela.toString();									
				vinculo.calcularRentaFinanciera(isAster, recibo.serie);
				
				return vinculo;
			}

			private function agregarVinculoVacio():void {
				var vinculo:VinculoDocumentos = new VinculoDocumentos();
				vinculo.docIdVin1 = null;
				vinculo.docIdVin2 = recibo.docId;
				vinculo.monto = null;
				vinculo.factura = new Documento();

				recibo.facturasVinculadas.addItem(vinculo);

				actualizarVinculos(vinculo, recibo.facturasVinculadas.length - 1);
			}

			private function actualizarVinculos(vinculo:VinculoDocumentos, index:int):void {
				updateTotalFacturasVinculadas();
				currentLine = vinculo;
				tieneCambios = true;
				invalidateProperties();
				
				callLater(function():void {
					var row:int = index;
					var col:int = 0;
					dgVinculos.setSelectedCell(row, col);
					
					callLater(function():void {
						dgVinculos.setFocus();
					});
				});
				
			}

			protected function cmdEmitir_clickHandler(event:MouseEvent):void {
				emitiendo_recibo = true;
				
				guardarRecibo();
			}

			private function resultEmitir(event:ResultEvent):void {
				var serieNumero:SerieNumero = event.result as SerieNumero;
				if (serieNumero) {
					_recibo.serie = serieNumero.serie;
					_recibo.numero = serieNumero.numero;

					for each (var o:Object in serieReciboList)  {
						if (o.value == _recibo.serie) {
							serieSelected = o;
						}
					}
					txtNumero.text = _recibo.numero.toString();
				}
				emitiendo_recibo = false;
				recibo.emitido = true;

				running = false;
				currentState = "default";

				var remObj:RemoteObject = new RemoteObject();
				remObj.destination = "CreatingRpc";
				remObj.channelSet = ServerConfig.getInstance().channelSet;
				remObj.addEventListener(FaultEvent.FAULT, handleFault);
				remObj.addEventListener(ResultEvent.RESULT, function(evt:ResultEvent):void {
						recibo = evt.result as Documento;
					});
				remObj.getDocumento(_recibo.docId);

			}
			
			public function obtenerFacturas(orden:String = null):void {
				if (!remFacturasCliente) {
					remFacturasCliente = new RemoteObject();
					remFacturasCliente.destination = "CreatingRpc";
					remFacturasCliente.channelSet = ServerConfig.getInstance().channelSet;
					remFacturasCliente.addEventListener(ResultEvent.RESULT, resultFacturasPendientes);
					remFacturasCliente.addEventListener(FaultEvent.FAULT, onFault);
				}
				
				var moneda:Moneda = cmbMonedaVinculos.selectedItem as Moneda;
				var cliente:Cliente = recibo.cliente;
				
				if (moneda && cliente) {
					var _docQuery:DocumentoQuery = new DocumentoQuery();
					_docQuery.start = 0;
					_docQuery.limit = 16;
					_docQuery.pendiente = false;
					_docQuery.cliente = cliente.codigo;
					_docQuery.moneda = moneda.codigo;
					_docQuery.tieneSaldo = true;
					_docQuery.orden = orden;
					_docQuery.comprobantes = "2,4,5,6,7,8,9,19,20,22,98";
					
					remFacturasCliente.queryDocumentos(_docQuery);
				} else {
					map = new Dictionary();
				}
				
			}
			
			private function resultFacturasPendientes(event:ResultEvent):void {
				var facturasPendientes:ArrayCollection = event.result as ArrayCollection;
				
				map = new Dictionary();
				for each (var doc:DocumentoDTO in facturasPendientes.toArray())  {
					map[doc.serieNumero] = doc;
				}
			}

			private function onFault(event:FaultEvent):void {
				map = new Dictionary();
				Alert.show(event.fault.faultString, 'Error');
			}
			
			public function getNetoTotal():BigDecimal {
				var netoTotal:BigDecimal = BigDecimal.ZERO;
				for each (var vinculo:VinculoDocumentos in recibo.facturasVinculadas) {
					if (vinculo.neto != null && vinculo.neto.length > 0) {
						netoTotal = netoTotal.add(new BigDecimal(vinculo.neto));
					}
				}				
				return netoTotal.setScale(4, MathContext.ROUND_HALF_EVEN);
			}

			public function getMontoTotal():BigDecimal {
				var montoTotal:BigDecimal = BigDecimal.ZERO;
				for each (var vinculo:VinculoDocumentos in recibo.facturasVinculadas) {
					if (vinculo.monto != null && vinculo.monto.length > 0) {
						montoTotal = montoTotal.add(new BigDecimal(vinculo.monto));
					}
				}				
				return montoTotal.setScale(4, MathContext.ROUND_HALF_EVEN);
			}

			public function getRentaTotal():BigDecimal {
				var rentaTotal:BigDecimal = BigDecimal.ZERO;
				for each (var vinculo:VinculoDocumentos in recibo.facturasVinculadas) {
					if (vinculo.vinRtaFin != null && vinculo.vinRtaFin.length > 0) {
						rentaTotal = rentaTotal.add(new BigDecimal(vinculo.vinRtaFin));
					}
				}				
				return rentaTotal.setScale(4, MathContext.ROUND_HALF_EVEN);
			}

			public function getDescuentoTotal():BigDecimal {
				var dtoTotal:BigDecimal = BigDecimal.ZERO;

				for each (var vinculo:VinculoDocumentos in recibo.facturasVinculadas) {
					var desc:String = vinculo.descuentoPorc;
					var monto_:String = vinculo.neto;
					
					var desto:BigDecimal = desc ? new BigDecimal(desc).setScale(4, MathContext.ROUND_HALF_EVEN) : BigDecimal.ZERO;
					var monto:BigDecimal = monto_ ? new BigDecimal(monto_).setScale(4, MathContext.ROUND_HALF_EVEN) : BigDecimal.ZERO;
					if ((Maths.ONE_HUNDRED.subtract(desto)).compareTo(BigDecimal.ZERO) != 0) { 
						var montoLinea:BigDecimal = monto.multiply(desto).divideScaleRound(Maths.ONE_HUNDRED.subtract(desto), 4, MathContext.ROUND_HALF_EVEN).setScale(4, MathContext.ROUND_HALF_EVEN);
						dtoTotal =  dtoTotal.add(montoLinea);
					}
				}
				
				return dtoTotal.setScale(4, MathContext.ROUND_HALF_EVEN);
			}
			
			protected function cmdAgregarVinculos_clickHandler(event:MouseEvent):void {
				// TODO Auto-generated method stub
			}
			
			protected function cmdCrearNotaCredito_clickHandler(event:MouseEvent):void {				
				var cmp:Comprobante = new Comprobante();
				for each (var comprobante:Comprobante in CatalogoFactory.getInstance().comprobantes)  {
					if (comprobante.codigo == "28") {
						cmp = comprobante; 	
						break;
					}
				}
				var art:Articulo = new Articulo();
				for each (var articulo:Articulo in CatalogoFactory.getInstance().articulos)  {
					if (articulo.codigo == "DESCUENTO") {
						art = articulo;
						break;
					}
				}	
				var iva:Iva = new Iva();
				iva.tasa = "22";
				art.iva = iva;
				
				var dtf:DateTimeFormatter = new DateTimeFormatter();
				dtf.setStyle("locale", "es-ES");
				dtf.dateTimePattern = "dd-MM-yyyy";
				
				var docVin:Documento = Documento.getNuevoDocumento(cmp);
				docVin.tomarCamposDelCliente(recibo.cliente.codigo);
				docVin.docTCC = recibo.docTCC;
				
				// Seteo el recibo que lo genera como el prevDocId
				docVin.prevDocId = recibo.docId;
				
				var razonCFERef:String = "";
				
				LineasDocumento(docVin.lineas).lineas.removeAll();
				
				var index:int = 0;
				for each (var vinculo:VinculoDocumentos in recibo.facturasVinculadas) {
					var desto:BigDecimal = vinculo.descuentoPorc && vinculo.descuentoPorc.length > 0 ? new BigDecimal(vinculo.descuentoPorc) : BigDecimal.ZERO;
					var monto:BigDecimal = new BigDecimal(vinculo.neto ? vinculo.neto : vinculo.monto);
					
					if (!monto || !desto) continue;
					
					var montoLinea:BigDecimal = monto;
					if ((Maths.ONE_HUNDRED.subtract(desto)).compareTo(BigDecimal.ZERO) != 0) { 
						montoLinea = monto.multiply(desto).divideScaleRound(Maths.ONE_HUNDRED.subtract(desto), 4, MathContext.ROUND_HALF_EVEN);
					}
					razonCFERef += vinculo.factura.numero + "\n"; 

					if (vinculo.monto != null && vinculo.monto.length > 0) {
						var precio:BigDecimal = montoLinea.divideScaleRound(new BigDecimal("1.22"), 4, MathContext.ROUND_HALF_EVEN);
						var concepto:String = recibo.serie + recibo.numero + ", dto:" + desto.setScale(2).toString() + "% en factura " + vinculo.factura.serie + vinculo.factura.numero;
						if (concepto.length > 50) {
							concepto = concepto.substr(0, 50);
						}
						
						// Guardo datos en la línea para el momento de dar el alta crear los vínculos
						var notas:String = recibo.docId + "|" + recibo.serie + "|" + recibo.numero + "|" + dtf.format(recibo.fechaDoc) + "|" + montoLinea.toString() + "\n";
						notas += vinculo.factura.docId + "|" + vinculo.factura.serie + "|" + vinculo.factura.numero + "|" + desto.setScale(2).toString() + "|" + vinculo.monto;
						
						// Agregar una linea vacia al documento
						var lineaDoc:LineaDocumento = new LineaDocumento();
						lineaDoc.numeroLinea = index;
						lineaDoc.cantidad = "1";
						lineaDoc.articulo = art;
						lineaDoc.documento = docVin;
						lineaDoc.concepto = concepto;
						lineaDoc.notas = notas;
						lineaDoc.precio = precio.setScale(4, MathContext.ROUND_HALF_EVEN).toString();
						lineaDoc.costo = precio.multiply(new BigDecimal(".64")).setScale(4, MathContext.ROUND_HALF_EVEN).toString();

						LineasDocumento(docVin.lineas).lineas.addItem(lineaDoc);
						
						// moneda de la nota de crédito debe ser la misma de las facturas vinculadas.
						if (index == 0) {
							docVin.moneda = vinculo.factura.moneda;
						}
						
						// Indice de la línea
						index++;
					}
				}
				
				docVin.indGlobalCFERef = "G";
				docVin.razonCFERef = razonCFERef;
				docVin.update();
				
				abrirNotaCreditoFinanciera(docVin);
			}
			
			private function abrirNotaCreditoFinanciera(doc:Documento):void {
				var facWindow:TitleWindow = new TitleWindow();
				facWindow.title = "Nota de crédito financiera";
				facWindow.width = 1120;
				facWindow.height = 718;
				
				facWindow.addEventListener(CloseEvent.CLOSE, closeHandlerNCF);
				
				var frmFactura:FacturacionPnl = new FacturacionPnl();
				frmFactura.factura = doc;
				frmFactura.showNuevo = false;
				frmFactura.showGuardar = false;
				frmFactura.showEMail = false;
				frmFactura.obtenerTipoCambioFiscal(new Date());
				frmFactura.tieneCambios = false;
				
				frmFactura.modoVentana = true;
								
				frmFactura.addEventListener("_cancel_", function():void {
					facWindow.removeEventListener(CloseEvent.CLOSE, closeHandlerNCF);
					PopUpManager.removePopUp(facWindow as IFlexDisplayObject);

					//TODO: Volver a cargar el documento
					reloadDocumento(_recibo.docId);
				});
				
				PopUpManager.addPopUp(facWindow, DisplayObject(FlexGlobals.topLevelApplication), true);
				PopUpManager.centerPopUp(facWindow);

				
				facWindow.addElement(frmFactura);

				facWindow.closeButton.visible = false;
				
			}
			
			private function closeHandlerNCF(event:Event):void {
				var titleWin:TitleWindow = event.target as TitleWindow;
				titleWin.removeEventListener(CloseEvent.CLOSE, closeHandler);
				PopUpManager.removePopUp(titleWin as IFlexDisplayObject);
				
				//TODO: Volver a cargar el documento
				reloadDocumento(_recibo.docId);
			}
			
			protected function cmdAuditoria_clickHandler(event:MouseEvent):void {
				var remAuditoria:RemoteObject = new RemoteObject();
				remAuditoria.destination = "CreatingRpc";
				remAuditoria.channelSet = ServerConfig.getInstance().channelSet;
				remAuditoria.addEventListener(ResultEvent.RESULT, function(evt:ResultEvent):void {
					var lineasAuditoria:ArrayCollection = evt.result as ArrayCollection;
					if (lineasAuditoria && lineasAuditoria.length > 0) {
						var helpWindow:TitleWindow = new TitleWindow();
						helpWindow.width = 840;
						helpWindow.height = 460;
						helpWindow.title = "Auditoría | " + (_recibo.serie ? _recibo.serie : "") + (_recibo.numero ? (_recibo.numero + " | ") : "") + _recibo.comprobante.nombre;
						
						var parent:Sprite;
						var sm:ISystemManager = ISystemManager(FlexGlobals.topLevelApplication.systemManager);
						// no types so no dependencies
						var mp:Object = sm.getImplementation("mx.managers.IMarshallPlanSystemManager");
						if (mp && mp.useSWFBridge()) {
							parent = Sprite(sm.getSandboxRoot());
						} else {
							parent = Sprite(FlexGlobals.topLevelApplication);
						}
						
						var lineasAudPanel:FrmLineasAuditoriaDoc = new FrmLineasAuditoriaDoc();
						lineasAudPanel.lineas = lineasAuditoria;
						var closeHandler:Function = function closeHandler(event:CloseEvent):void {
							PopUpManager.removePopUp(helpWindow as IFlexDisplayObject);
						}
						
						lineasAudPanel.addEventListener(CloseEvent.CLOSE, closeHandler);
						helpWindow.addEventListener(CloseEvent.CLOSE, closeHandler);
						
						helpWindow.addElement(lineasAudPanel);
						PopUpManager.addPopUp(helpWindow, parent, true);
						PopUpManager.centerPopUp(helpWindow);
					} else {
						var alert:Alert = Alert.show("'" + (_recibo.serie ? _recibo.serie : "") + (_recibo.numero ? _recibo.numero : " | ") + _recibo.comprobante.nombre + "' no tiene auditoría.", "Información");
						alert.width = 400;
						alert.height = 200;
					}
					
				});
				remAuditoria.addEventListener(FaultEvent.FAULT, handleFault);
				
				if (_recibo.docId) {
					remAuditoria.getLineasAuditoria(_recibo.docId);
				}				
			}


			protected function ddlSerie_changeHandler(event:IndexChangeEvent):void {
				serieSelected = ddlSerie.selectedItem as Object;
				_recibo.serie = serieSelected ? serieSelected.value : "";
				
				tieneRF = _recibo.serie && _recibo.serie.length > 0 && _recibo.serie != "A" && _recibo.serie != "P";
			}
			
			protected function cmdMostrarFacturasPendientes_clickHandler(event:MouseEvent):void {
				var facPendWindow:TitleWindow = new TitleWindow();
				facPendWindow.title = "Facturas Pendientes: " + recibo.cliente.nombre;
				facPendWindow.width = 860;
				facPendWindow.height = 600;
				
				var frmListadoDeudores:ListadoDeudoresCliente = new ListadoDeudoresCliente();
				
				var docPendientes:ArrayCollection = new ArrayCollection();
				docPendientes.addItem(_recibo.cliente.documentsPendientes);
				
				frmListadoDeudores.dataProvider = docPendientes;
				frmListadoDeudores.codigoCliente = recibo.cliente.codigo;
				
				var parent:Sprite;
				var sm:ISystemManager = ISystemManager(FlexGlobals.topLevelApplication.systemManager);

				var mp:Object = sm.getImplementation("mx.managers.IMarshallPlanSystemManager");
				if (mp && mp.useSWFBridge()) {
					parent = Sprite(sm.getSandboxRoot());
				} else {
					parent = Sprite(FlexGlobals.topLevelApplication);
				}
				
				PopUpManager.addPopUp(facPendWindow, parent, true);
				PopUpManager.centerPopUp(facPendWindow);
				
				frmListadoDeudores.addEventListener(CloseEvent.CLOSE, function(event:CloseEvent):void {
					PopUpManager.removePopUp(facPendWindow as IFlexDisplayObject);
					facPendWindow = null;
				});
				
				facPendWindow.addElement(frmListadoDeudores);
				
				facPendWindow.closeButton.visible = false;
			}
			
			protected function cmdAbrirNotaCredito_clickHandler(event:MouseEvent):void {
				dispatchEvent(new AbrirFacturaEvent(AbrirFacturaEvent.ABRIR_DOCUMENTO, recibo.prevDocId));
			}
			
			protected function cmdDocumentos_clickHandler(event:MouseEvent):void {
				var facPendWindow:TitleWindow = new TitleWindow();
				facPendWindow.title = "Documentos y Valores";
				facPendWindow.width = 720;
				facPendWindow.height = 500;
				
				var frmDocumentosValores:FrmDocumentosValores = new FrmDocumentosValores();
				frmDocumentosValores.recibo = _recibo;

				var parent:Sprite;
				var sm:ISystemManager = ISystemManager(FlexGlobals.topLevelApplication.systemManager);
				
				// no types so no dependencies
				var mp:Object = sm.getImplementation("mx.managers.IMarshallPlanSystemManager");
				if (mp && mp.useSWFBridge()) {
					parent = Sprite(sm.getSandboxRoot());
				} else {
					parent = Sprite(FlexGlobals.topLevelApplication);
				}
				
				PopUpManager.addPopUp(facPendWindow, parent, true);
				PopUpManager.centerPopUp(facPendWindow);
				
				frmDocumentosValores.addEventListener(CloseEvent.CLOSE, function(event:CloseEvent):void {
					PopUpManager.removePopUp(facPendWindow as IFlexDisplayObject);
					facPendWindow = null;
				});
				
				frmDocumentosValores.addEventListener("save_documentos_y_valores", function(event:Event):void {
					guardarRecibo();
				});
				
				facPendWindow.addElement(frmDocumentosValores);
				
				facPendWindow.closeButton.visible = false;
			}
			
			protected function txtDate_changeHandler(event:CalendarLayoutChangeEvent):void {
				recibo.fechaDoc = event.newDate;
			}
			
			protected function cmdFinalizar_clickHandler(event:MouseEvent):void {
				var docId:String = _recibo.docId;
				
				var remObjR:RemoteObject = new RemoteObject();
				remObjR.destination = "CreatingRpc";
				remObjR.showBusyCursor = true;
				remObjR.channelSet = ServerConfig.getInstance().channelSet;
				remObjR.addEventListener(FaultEvent.FAULT, handleFault);
				remObjR.addEventListener(ResultEvent.RESULT, function(evt1:ResultEvent):void {
					var remObj1:RemoteObject = new RemoteObject();
					remObj1.destination = "CreatingRpc";
					remObj1.showBusyCursor = true;
					remObj1.channelSet = ServerConfig.getInstance().channelSet;
					remObj1.addEventListener(FaultEvent.FAULT, handleFault);
					remObj1.addEventListener(ResultEvent.RESULT, function(evt:ResultEvent):void {
						recibo = evt.result as Documento;
					});
					remObj1.getDocumento(docId);
				});
				
				remObjR.finalizarRecibo(_recibo);
				
			}
			
			protected function cmbMoney_changeHandler(event:Event):void {
				recibo.docRecMda = cmbMoney.selectedItem as Moneda;
				recibo.moneda = cmbMoney.selectedItem as Moneda; 	
				
				monedasDistintas = false;
			}
			
			protected function txtTotal_changeHandler(event:Event):void {
				recibo.docRecNeto = txtTotal.text;
				recibo.saldo = txtTotal.text;

				if (!isAster) {
					var monedaVinculos:Moneda = cmbMonedaVinculos.selectedItem;
					var monedaDocRecNeto:Moneda = cmbMoney.selectedItem;
					
					var docReciboNeto:BigDecimal = recibo.getDocRecNeto();
					var docReciboTotal:BigDecimal = BigDecimal.ZERO;
					if (recibo.total && recibo.total.length > 0) {
						docReciboTotal = new BigDecimal(recibo.total); 
					}
					
					if (monedaDocRecNeto.codigo == monedaVinculos.codigo) {
						recibo.total = recibo.docRecNeto;
						
					} else {
						var total:BigDecimal = recibo.convertirMoneda(monedaDocRecNeto, monedaVinculos, recibo.getDocRecNeto());
						recibo.total = total.setScale(2, MathContext.ROUND_HALF_EVEN).toString();
					}
					txtTotalVinculado.text = recibo.total;
					
					updateTotalFacturasVinculadas();
				}			
			}
						
			protected function txtTotalVinculado_changeHandler(event:Event):void {
				recibo.total = txtTotalVinculado.text;
				var monedaVinculos:Moneda = cmbMonedaVinculos.selectedItem;
				var monedaDocRecNeto:Moneda = cmbMoney.selectedItem;
				
				var docReciboNeto:BigDecimal = recibo.getDocRecNeto();
				var docReciboTotal:BigDecimal = BigDecimal.ZERO;
				if (recibo.total && recibo.total.length > 0) {
					docReciboTotal = new BigDecimal(recibo.total); 
				}
				
				if (monedaVinculos.codigo == Moneda.PESOS || monedaVinculos.codigo == Moneda.PESOS_ASTER) {
					recibo.docTCC = docReciboTotal.divideRound(docReciboNeto, MathContext.ROUND_HALF_EVEN).toString(); 	
				}
				if (monedaVinculos.codigo == Moneda.DOLARES || monedaVinculos.codigo == Moneda.DOLARES_ASTER) {
					if (docReciboTotal.compareTo(BigDecimal.ZERO) > 0) {
						recibo.docTCC = docReciboNeto.divideRound(docReciboTotal, MathContext.ROUND_HALF_EVEN).toString();
					} else {
						recibo.docTCC = BigDecimal.ZERO.toString();
					}
				}
				
				txtTipoCambio.text = recibo.docTCC;
			}
			
			protected function cmbMonedaVinculos_changeHandler(event:Event):void {
				var monedaVinculos:Moneda = cmbMonedaVinculos.selectedItem;
				var monedaTotal:Moneda = cmbMoney.selectedItem;
				monedasDistintas = monedaTotal.codigo != monedaVinculos.codigo;
				
				if (monedaTotal.codigo == monedaVinculos.codigo) {
					recibo.total = recibo.docRecNeto;
				} else {
					txtTotalVinculado.enabled = true;
					var total:BigDecimal = recibo.convertirMoneda(monedaTotal, monedaVinculos, recibo.getDocRecNeto());
					recibo.total = total.setScale(2, MathContext.ROUND_HALF_EVEN).toString();
				}
				txtTotalVinculado.text = recibo.total;

			}
			
			protected function txtTipoCambio_changeHandler(event:Event):void {
				var monedaVinculos:Moneda = cmbMonedaVinculos.selectedItem;
				var monedaRecibo:Moneda = cmbMoney.selectedItem;
				
				var total:BigDecimal = recibo.convertirMoneda(monedaRecibo, monedaVinculos, recibo.getDocRecNeto());
				recibo.total = total.setScale(2, MathContext.ROUND_HALF_EVEN).toString();
				txtTotalVinculado.text = recibo.total;
			}
			
			protected function txtDate_closeHandler(event:DropdownEvent):void {
				cmdGuardar.setFocus();	
			}
			
		]]>

	</fx:Script>

	<fx:Declarations>
		<fx:Component id="dropDownItemRenderer">
			<renderers:CodigoNombreItemRenderer />
		</fx:Component>

		<util:RutValidator id="rut_stringValidator" source="{txtRUT}" required="false" property="text" minLength="12" maxLength="12" tooShortError="Número de RUT inválido." checkRut="true" />
		<s:NumberFormatter id="nf_Espanol_Espanol" fractionalDigits="2" locale="es_ES" />
		
	</fx:Declarations>

	<s:states>
		<s:State name="default" />
		<s:State name="cargando" />
	</s:states>

	<s:VGroup width="100%" height="100%" horizontalAlign="center" verticalAlign="middle" includeIn="cargando">
		<loader:LoadComponent />
	</s:VGroup>

	<s:Group width="100%" height="100%" excludeFrom="cargando">		
		<s:Rect x="408" y="7" width="186" height="36" visible="{recibo.emitido}">
			<s:fill>
				<s:LinearGradient rotation="90">
					<s:GradientEntry color="0xFFFFFF" ratio="0.2" alpha="0.23" />
					<s:GradientEntry color="0xFFFFFF" ratio="0.48" alpha="0.32" />
					<s:GradientEntry color="0xFFFFFF" ratio="0.48001" alpha="0.63" />
				</s:LinearGradient>
			</s:fill>
			<s:stroke>
				<s:LinearGradientStroke rotation="90" weight="3">
					<s:GradientEntry color="0xFF0000" alpha="0.70" ratio="0.4" />
					<s:GradientEntry color="0xFA0000" alpha="0.40" ratio="0.965" />
					<s:GradientEntry color="0xFF0000" alpha="0.30" ratio="0.9651" />
				</s:LinearGradientStroke>
			</s:stroke>
		</s:Rect>
		<s:Label width="120" color="#ff0000" fontSize="24" left="440" textAlign="center" top="15" text="Emitido" 
				 visible="{recibo.emitido}" />

		<s:VGroup width="100%" height="100%" excludeFrom="cargando">
			<s:VGroup width="100%" height="100%">
				<s:HGroup id="pnlHeader" width="100%" gap="5" >
					<s:Panel width="120" title="SERIE" styleName="pnlInterno" minHeight="0">
						<s:HGroup width="100%" horizontalAlign="center">
							<s:DropDownList id="ddlSerie" width="100%" dataProvider="{serieReciboList}" labelField="label" height="36" enabled="{!_modoVisualizacion &amp;&amp; !recibo.emitido &amp;&amp; !tieneVinculos}" 
											selectedItem="{serieSelected}" change="ddlSerie_changeHandler(event)" fontSize="18"/>
						</s:HGroup>
					</s:Panel>
					<s:Panel width="180" title="NÚMERO" styleName="pnlInterno" minHeight="0" >
						<s:HGroup width="100%" horizontalAlign="center">
							<s:TextInput id="txtNumero" width="100%" height="36" paddingRight="15" textAlign="right"  fontSize="18"
										 text="@{recibo.numero}" enabled="{!_modoVisualizacion &amp;&amp; !recibo.emitido &amp;&amp; !tieneVinculos}" enter="{txtTipoCambio.setFocus()}"/>
						</s:HGroup>
					</s:Panel>
					<s:HGroup width="100%" height="60" horizontalAlign="center" verticalAlign="middle" visible="{!recibo.docId}">
						<s:Label text="Para agregar facturas vinculadas debe guardar el recibo." fontSize="14" fontStyle="italic" />
					</s:HGroup>
				
					<s:Panel width="180" title="FECHA" styleName="pnlInterno" minHeight="0">
						<s:HGroup width="100%" horizontalAlign="center">
							<mx:DateField id="txtDate" width="100%" fontSize="18" fontFamily="Helvetica" paddingLeft="10" focusEnabled="false" selectedDate="{recibo.fechaDoc}" yearNavigationEnabled="true"
										  formatString="DD/MM/YYYY" locale="es" enabled="{!_modoVisualizacion &amp;&amp; !recibo.emitido}" change="txtDate_changeHandler(event)" close="txtDate_closeHandler(event)"/>
						</s:HGroup>
					</s:Panel>
				</s:HGroup>
	
				<s:HGroup width="100%" height="100%">
					<s:VGroup width="30%" height="100%">
						<s:VGroup width="100%" height="100%" horizontalAlign="right" gap="5">
							<s:HGroup width="100%" horizontalAlign="right" paddingTop="5" gap="0">
								<s:Panel width="120" title="T.C.COMERCIAL" styleName="pnlInterno" minHeight="0" >
									<s:HGroup width="100%" horizontalAlign="center">
										<components1:MyTextInput id="txtTipoCambio" width="100%" height="36" fontSize="16" textAlign="right" permitirNegativos="false" text="@{recibo.docTCC}" 
																 enter="{cmbMoney.setFocus()}" enabled="{!tieneVinculos}" change="txtTipoCambio_changeHandler(event)"/>
									</s:HGroup>
								</s:Panel>
								<s:Spacer width="100%" />
								<s:Panel width="180" title="MONEDA" styleName="pnlInterno" minHeight="0" >
									<s:HGroup width="100%" horizontalAlign="center">
										<components:MyAutoComplete id="cmbMoney" width="100%" height="36" fontSize="16" textAlign="left" dataProvider="{ monedas }" labelField="nombre" matchType="anyPart"
																   allowNewValues="false" selectedItemStyleName="{ AutoComplete.STYLE_MAC_MAIL }" allowDuplicates="false" allowMultipleSelection="false"
																   allowEditingNewValues="false" dropDownItemRenderer="{ dropDownItemRenderer }" labelFunction="codigoNombreLabelFunction"
																   backspaceAction="focus" dropDownRowCount="{monedas.length}" selectedItem="{recibo.docRecMda}" change="cmbMoney_changeHandler(event)" 
																   next_focus="{txtTotal}" previous_focus="{txtTipoCambio}" enabled="{!tieneVinculos}"/>
									</s:HGroup>
								</s:Panel>
								<s:Panel width="120" title="{isAster ? 'NETO' : 'TOTAL' }" styleName="pnlInterno" minHeight="0">
									<s:HGroup width="100%" horizontalAlign="center">
										<components1:MyTextInput id="txtTotal" width="100%" height="36" fontSize="16" textAlign="right" permitirNegativos="false" text="{recibo.docRecNeto}" change="txtTotal_changeHandler(event)" 
																 enter="{cmbClient.setFocus()}" enabled="{!tieneVinculos}" />
									</s:HGroup>
								</s:Panel>
							</s:HGroup>
	
							<s:HGroup width="100%" gap="0">
								<s:Panel width="100%" minHeight="0" title="R.U.T COMPRADOR" styleName="pnlInterno">
									<s:HGroup width="100%" horizontalAlign="center">
										<s:TextInput id="txtRUT" width="100%" height="36" fontSize="18" paddingLeft="12" textAlign="left" change="txtRUT_changeHandler(event)" prompt="No tiene"
													 text="@{recibo.rut}" restrict="0-9" editable="true" maxChars="12" enabled="{!_modoVisualizacion &amp;&amp; !recibo.emitido}" />
									</s:HGroup>
								</s:Panel>
							</s:HGroup>
	
							<s:Panel width="100%" height="100%" title="DATOS CLIENTE" styleName="pnlInterno" minHeight="0" >
								<s:HGroup width="100%" horizontalAlign="center">
									<s:Form width="100%" textAlign="right">
										<s:layout>
											<s:FormLayout gap="-12" />
										</s:layout>

										<s:FormItem width="100%" label="Cliente">
											<s:HGroup width="100%" gap="3" verticalAlign="middle">
												<components:MyAutoComplete id="cmbClient" width="100%" textAlign="left" change="cmbClient_changeHandler(event)"
																		   keyDown="capture_keyDownHandlerCliente(event)" dataProvider="{ CatalogoFactory.getInstance().clientes }" labelField="nombre"
																		   matchType="anyPart" prompt="Ingrese cliente" allowNewValues="false" selectedItemStyleName="{ AutoComplete.STYLE_MAC_MAIL }"
																		   allowDuplicates="false" allowMultipleSelection="false" allowEditingNewValues="false"
																		   dropDownItemRenderer="{ dropDownItemRenderer }" labelFunction="clienteLabelFunction" backspaceAction="focus"
																		   next_focus="{txtRazonSocial}" dropDownWidth="480" dropDownRowCount="10" selectedItem="{recibo.cliente}" enabled="{!tieneVinculos}" />

												<components1:IconButton  styleName="moneyButton" width="28" height="26" toolTip="Facturas Pendientes" 
																		 click="cmdMostrarFacturasPendientes_clickHandler(event)" 
																		 enabled="{recibo.cliente &amp;&amp; recibo.cliente.documentsPendientes}" />

											</s:HGroup>
										</s:FormItem>
										<s:FormItem width="100%" label="Razón social">
											<s:TextInput id="txtRazonSocial" width="100%" textAlign="left" prompt="Ingrese razón social" text="@{recibo.razonSocial}" editable="{!_modoVisualizacion}"
														 maxChars="128" enabled="{!tieneVinculos}" enter="{txtDate.setFocus();txtDate.open();}"/>
										</s:FormItem>
										<s:FormItem width="100%" label="Departamento">
											<s:TextInput id="txtDpto" width="100%" textAlign="left" enter="{txtDirection.setFocus()}" prompt="Departamento" text="@{recibo.departamento}" editable="false" maxChars="40" enabled="{!tieneVinculos}"/>
										</s:FormItem>
										<s:FormItem width="100%" label="Dirección">
											<s:TextInput id="txtDirection" width="100%" textAlign="left" enter="{txtRUT.setFocus()}" prompt="Dirección" text="@{recibo.direccion}" editable="false" maxChars="100" enabled="{!tieneVinculos}"/>
										</s:FormItem>
									</s:Form>
								</s:HGroup>
							</s:Panel>
						</s:VGroup>	
					</s:VGroup>
	
					<s:VGroup width="100%" height="100%" paddingTop="5">
						<s:Panel id="pnlFacturasVinculadas" width="100%" height="100%" title="FACTURAS VINCULADAS" styleName="pnlInterno" enabled="{recibo.docId != null}">
							<s:VGroup width="100%" height="100%" gap="0">
								<s:HGroup width="100%">
									<s:Panel width="180" title="MONEDA VINCULOS" styleName="pnlInterno" minHeight="0">
										<s:HGroup width="100%" horizontalAlign="center">
											<components:MyAutoComplete id="cmbMonedaVinculos" width="100%" height="36" fontSize="14" textAlign="left" dataProvider="{ monedas }" labelField="nombre" matchType="anyPart"
																	   allowNewValues="false" selectedItemStyleName="{ AutoComplete.STYLE_MAC_MAIL }" allowDuplicates="false" allowMultipleSelection="false"
																	   allowEditingNewValues="false" dropDownItemRenderer="{ dropDownItemRenderer }" labelFunction="codigoNombreLabelFunction" 
																	   backspaceAction="focus" dropDownRowCount="{monedas.length}" selectedItem="@{recibo.moneda}" enabled="{!tieneVinculos}"
																	   change="cmbMonedaVinculos_changeHandler(event)"/>
										</s:HGroup>
									</s:Panel>
									<s:Panel width="180" title="{isAster ? 'NETO' : 'TOTAL' }" styleName="pnlInterno" minHeight="0">
										<s:HGroup width="100%" horizontalAlign="center" paddingBottom="10">
											<components1:MyTextInput id="txtTotalVinculado" width="100%" height="36" fontSize="16" textAlign="right" permitirNegativos="false" text="{recibo.total}" 
																	 change="txtTotalVinculado_changeHandler(event)" enabled="{!tieneVinculos &amp;&amp; monedasDistintas}"/>
										</s:HGroup>
									</s:Panel>
								</s:HGroup>
	
								<s:DataGrid id="dgVinculos" width="100%" height="100%" fontSize="10" creationComplete="dgVinculos_creationCompleteHandler(event)"
											keyDown="dgVinculos_keyDownHandler(event)" gridItemEditorSessionSave="dgVinculos_gridItemEditorSessionSaveHandler(event)"
											dataProvider="{recibo.facturasVinculadas}" selectionMode="singleCell" sortableColumns="false" editable="true">
									
									<s:columns>
										<s:ArrayList>
											<s:GridColumn  width="80" sortable="false" headerText="S/N" editable="{!recibo.emitido}" resizable="false">
												<s:itemEditor>
													<fx:Component>
														<s:GridItemEditor>
															<fx:Script>
																<![CDATA[
																	import biz.fulltime.model.Articulo;
																	import biz.fulltime.model.LineaDocumento;
																	import biz.fulltime.model.VinculoDocumentos;
																	
																	import mx.events.FlexEvent;
																	
																	import spark.components.DataGrid;
																	import spark.events.TextOperationEvent;
																	
																	import util.CatalogoFactory;
																	
																	override public function get value():Object {
																		return txtSerieNumero.text;
																	}
																	
																	// Override the setter to initialize the TextInput control
																	// with the cell data.
																	override public function set value(newValue:Object):void {
																		txtSerieNumero.text = newValue as String;
																	}
																	
																	override public function set data(value:Object):void {
																		super.data = value;
																		var vinculoFactura:VinculoDocumentos = VinculoDocumentos(value);
																		
																		if (vinculoFactura && vinculoFactura.factura) {
																			if (!vinculoFactura.factura.serie) {
																				vinculoFactura.factura.serie = "";
																			}
																			if (!vinculoFactura.factura.numero) {
																				vinculoFactura.factura.numero = "";
																			}																				
																			txtSerieNumero.text = vinculoFactura.factura.serie + vinculoFactura.factura.numero;
																			txtSerieNumero.selectAll();
																			
																		} else {
																			txtSerieNumero.text = "";
																			//txtSerieNumero.selectAll();
																			
																		}
																	}
																	
																	// Override setFocus() to shift focus to the NumericStepper.
																	override public function setFocus():void {
																		txtSerieNumero.setFocus();
																	}

																	
																	protected function txtSerieNumero_changeHandler(event:TextOperationEvent):void {
																		var text:String = txtSerieNumero.text;
																		
																		var count:int = txtSerieNumero.text.length;
																		var index:int = 0;
																		
																		var serie:String = "";
																		var numero:String = "";
																		
																		for (; index < count; index++) {
																			serie = text.substr(index, 1); 
																			if( !isNaN( Number(serie) ) ) {
																				break;
																			}
																		}
																		
																		serie = (count > 0 ? text.substring(0, index) : "");
																		numero = (count > 0 ? text.substring(index) : "");
																		
																		var vinculoFactura:VinculoDocumentos = VinculoDocumentos(data);
																		if (!vinculoFactura.factura.comprobante) {
																			vinculoFactura.factura.serie = serie;
																			vinculoFactura.factura.numero = numero;
																		}																	
																		
																	}
																	
																]]>
															</fx:Script>
															<s:TextInput id="txtSerieNumero" width="100%" height="100%" change="txtSerieNumero_changeHandler(event)" restrict="0-9a-zA-Z" /> 
														</s:GridItemEditor>
													</fx:Component>
												</s:itemEditor>
												<s:itemRenderer>
													<fx:Component>
														<s:DefaultGridItemRenderer fontSize="12" textAlign="left">
															<fx:Script>
																<![CDATA[
																	import biz.fulltime.model.VinculoDocumentos;
																	
																	override public function prepare(hasBeenRecycled:Boolean):void {
																		if (!data) {
																			return;
																		}
																		var vinculoFactura:VinculoDocumentos = VinculoDocumentos(data);
																		
																		var serie:String = vinculoFactura.factura.serie;
																		var numero:String = vinculoFactura.factura.numero;
																		label = (serie ? serie : "") + (numero ? numero : "");
																	}
																]]>
															</fx:Script>
														</s:DefaultGridItemRenderer>
													</fx:Component>
												</s:itemRenderer>
											</s:GridColumn>
	
											<s:GridColumn sortable="false" headerText="COMPROBANTE" editable="false" dataField="factura" resizable="false">
												<s:itemRenderer>
													<fx:Component>
														<s:DefaultGridItemRenderer fontSize="12" textAlign="left">
															<fx:Script>
																<![CDATA[
																	import biz.fulltime.model.VinculoDocumentos;
	
																	override public function prepare(hasBeenRecycled:Boolean):void {
																		if (!data) {
																			return;
																		}
																		var vinculoFactura:VinculoDocumentos = VinculoDocumentos(data);
	
																		if (vinculoFactura.docIdVin1 != null) {
																			label = vinculoFactura.factura.comprobante ? vinculoFactura.factura.comprobante.nombre : "";
																		} else {
																			label = "";
																		}
																	}
																]]>
															</fx:Script>
														</s:DefaultGridItemRenderer>
													</fx:Component>
												</s:itemRenderer>
											</s:GridColumn>
	
											<s:GridColumn width="78" dataField="factura.fecha" headerText="FECHA" editable="false" labelFunction="date_labelFunction">
												<s:itemRenderer>
													<fx:Component>
														<s:DefaultGridItemRenderer fontSize="12" textAlign="left"/>
													</fx:Component>
												</s:itemRenderer>
											</s:GridColumn>
	
											<s:GridColumn width="78" dataField="factura.moneda" resizable="false" headerText="MONEDA" editable="false" labelFunction="moneda_labelFunction" >
												<s:itemRenderer>
													<fx:Component>
														<s:DefaultGridItemRenderer fontSize="12" textAlign="left"/>
													</fx:Component>
												</s:itemRenderer>
											</s:GridColumn>
											
											<s:GridColumn width="80" dataField="factura.total" headerText="TOTAL" editable="false" labelFunction="total_labelFunction">
												<s:itemRenderer>
													<fx:Component>
														<s:DefaultGridItemRenderer fontSize="12" textAlign="right"/>
													</fx:Component>
												</s:itemRenderer>
											</s:GridColumn>

											<s:GridColumn width="80" dataField="factura.saldo" resizable="false" headerText="SALDO" editable="false" labelFunction="saldo_labelFunction" >
												<s:itemRenderer>
													<fx:Component>
														<s:DefaultGridItemRenderer fontSize="12" textAlign="right"/>
													</fx:Component>
												</s:itemRenderer>
											</s:GridColumn>

											<s:GridColumn width="60" dataField="descuentoPorc" headerText="DESCUENTO" editable="{!recibo.emitido}" itemEditor="biz.fulltime.ui.forms.DGNumberEditor" visible="{recibo.serie != 'A'}">
												<s:itemRenderer>
													<fx:Component>
														<s:DefaultGridItemRenderer fontSize="12" textAlign="right">
															<fx:Script>
																<![CDATA[
																	import biz.fulltime.model.VinculoDocumentos;
																	
																	override public function prepare(hasBeenRecycled:Boolean):void {
																		if (!data) {
																			return;
																		}
																		var desc:String = VinculoDocumentos(data).descuentoPorc;
																		var descuento:BigDecimal = new BigDecimal(desc ? desc : "0").setScale(2, MathContext.ROUND_HALF_EVEN);
																		
																		label = outerDocument.nf_Espanol_Espanol.format(descuento) + "%";
																		
																		setStyle("color",  VinculoDocumentos(data).cambios["descuentoPorc"] ? "#ff0000" : "#003300");
																	}
																]]>
															</fx:Script>
														</s:DefaultGridItemRenderer>
													</fx:Component>
												</s:itemRenderer>
											</s:GridColumn>

											<s:GridColumn width="70" dataField="descuentoMonto" headerText="M.DESCUENTO" editable="{!recibo.emitido}" itemEditor="biz.fulltime.ui.forms.DGNumberEditor" visible="{recibo.serie != 'A'}">
												<s:itemRenderer>
													<fx:Component>
														<s:DefaultGridItemRenderer fontSize="12" textAlign="right">
															<fx:Script>
																<![CDATA[
																	import biz.fulltime.model.VinculoDocumentos;
																	
																	import util.Maths;
																	
																	override public function prepare(hasBeenRecycled:Boolean):void {
																		if (!data) {
																			return;
																		}
																		var montoDto_:String = VinculoDocumentos(data).descuentoMonto;
																		var montoDto:BigDecimal = montoDto_ ? new BigDecimal(montoDto_).setScale(4, MathContext.ROUND_HALF_EVEN) : BigDecimal.ZERO;

																		label = outerDocument.nf_Espanol_Espanol.format(montoDto);
																		
																		setStyle("color",  VinculoDocumentos(data).cambios["descuentoMonto"] ? "#ff0000" : "#003300");
																	}
																]]>
															</fx:Script>
														</s:DefaultGridItemRenderer>
													</fx:Component>
												</s:itemRenderer>
											</s:GridColumn>

											<s:GridColumn width="90" dataField="neto" headerText="{isAster ? 'M.NETO' : 'M.VINCULADO'}" editable="{!recibo.emitido}" itemEditor="biz.fulltime.ui.forms.DGNumberEditor">
												<s:itemRenderer>
													<fx:Component>
														<s:DefaultGridItemRenderer fontSize="12" textAlign="right">
															<fx:Script>
																<![CDATA[
																	import biz.fulltime.model.VinculoDocumentos;
	
																	override public function prepare(hasBeenRecycled:Boolean):void {
																		if (!data)  return;
																		
																		var n:String = VinculoDocumentos(data).neto;
																		var neto:BigDecimal = new BigDecimal(n ? n : "0").setScale(2, MathContext.ROUND_HALF_EVEN);
																		
																		label = outerDocument.nf_Espanol_Espanol.format(neto);
																		
																		setStyle("color",  VinculoDocumentos(data).cambios["neto"] ? "#ff0000" : "#000000");
																	}
																]]>
															</fx:Script>
														</s:DefaultGridItemRenderer>
													</fx:Component>
												</s:itemRenderer>
											</s:GridColumn>
											
											<s:GridColumn width="70" dataField="monto"  headerText="M.CANCELA" editable="{!recibo.emitido}" itemEditor="biz.fulltime.ui.forms.DGNumberEditor">
												<s:itemRenderer>
													<fx:Component>
														<s:DefaultGridItemRenderer fontSize="12" textAlign="right">
															<fx:Script>
																<![CDATA[
																	import biz.fulltime.model.VinculoDocumentos;
																	
																	override public function prepare(hasBeenRecycled:Boolean):void {
																		if (!data) return;
																		
																		var m:String = VinculoDocumentos(data).monto;
																		var monto:BigDecimal = new BigDecimal(m ? m : "0").setScale(2, MathContext.ROUND_HALF_EVEN);
																		label = outerDocument.nf_Espanol_Espanol.format(monto);

																		setStyle("color",  VinculoDocumentos(data).cambios["cancela"] ? "#ff0000" : "#000000");
																	}
																]]>
															</fx:Script>
														</s:DefaultGridItemRenderer>
													</fx:Component>
												</s:itemRenderer>
											</s:GridColumn>

											
											<s:GridColumn width="70" headerText="RENTA FINANCIERA"  editable="false" visible="{tieneRF}">
												<s:itemRenderer>
													<fx:Component>
														<s:DefaultGridItemRenderer fontSize="12" textAlign="right">
															<fx:Script>
																<![CDATA[
																	import biz.fulltime.model.VinculoDocumentos;
																	
																	override public function prepare(hasBeenRecycled:Boolean):void {
																		if (!data) {
																			return;
																		}																		
																		label = outerDocument.nf_Espanol_Espanol.format(VinculoDocumentos(data).vinRtaFin);
																	}
																]]>
															</fx:Script>
														</s:DefaultGridItemRenderer>
													</fx:Component>
												</s:itemRenderer>
											</s:GridColumn>

	
											<s:GridColumn width="34" headerText="" rendererIsEditable="true" visible="{!recibo.emitido}">
												<s:itemRenderer>
													<fx:Component>
														<s:GridItemRenderer>
															<fx:Script>
																<![CDATA[
																	import biz.fulltime.model.VinculoDocumentos;
	
																	import mx.controls.Alert;
																	import mx.events.CloseEvent;
	
																	protected function cmdRemove_clickHandler(event:MouseEvent):void {
																		var vinculoFactura:VinculoDocumentos = VinculoDocumentos(data);
	
																		if (vinculoFactura.docIdVin1 != null) {
																			var serieNumero:String = VinculoDocumentos(data).factura.serie + VinculoDocumentos(data).factura.numero;
																			var alert:Alert = Alert.show("¿Esta usted seguro de quitar factura " + serieNumero + "?", "Borrar Vínculo", Alert.YES + Alert.NO, null, myCloseHandler);
																			alert.width = 400;
																			alert.height = 200;
																			
																		} else {
															 				this.outerDocument.borrarVinculo();
																		}
																	}
	
																	private function myCloseHandler(event:CloseEvent):void {
																		if (event.detail == Alert.YES) {
																			this.outerDocument.borrarVinculo();
																		}
																	}
																	
																]]>
															</fx:Script>
	
															<s:VGroup width="100%" height="100%" horizontalAlign="center" paddingLeft="2" verticalAlign="middle" creationComplete="cmdRemove.setFocus()">
																<s:Button id="cmdRemove" width="100%" height="100%" icon="@Embed('/assets/general/trash.png')" click="cmdRemove_clickHandler(event)"
																		  focusEnabled="false" toolTip="Quitar" />
															</s:VGroup>
														</s:GridItemRenderer>
													</fx:Component>
												</s:itemRenderer>
											</s:GridColumn>
	
										</s:ArrayList>
									</s:columns>
								</s:DataGrid>
								<s:HGroup width="100%" height="36" horizontalAlign="right" paddingBottom="2" paddingLeft="5" paddingRight="5" verticalAlign="middle">
									<s:Label id="lblSaldoPendiente" fontSize="14" />
									<s:Spacer width="100%" />
									<s:Label id="lblMontoTotal" fontSize="14" text="Monto total" />
								</s:HGroup>
							</s:VGroup>
	
							<s:controlBarContent>
								<s:HGroup width="100%" horizontalAlign="right" paddingBottom="0" paddingTop="0" verticalAlign="middle">
									<s:Spacer width="100%" />
									<s:Button id="cmdAgregar" width="140" click="cmdAgregar_clickHandler(event)" styleName="textButton" label="Agregar vinculo" toolTip="Agregar factura"
											  focusEnabled="true" enabled="{saldoPendiente.numberValue() > 0}" visible="{!recibo.emitido}"/>
								</s:HGroup>
							</s:controlBarContent>
	
						</s:Panel>
					</s:VGroup>
	
				</s:HGroup>
			</s:VGroup>
			<s:HGroup width="100%" gap="0">
				<s:Panel width="100%" title="NOTAS DEL COMPROBANTE" styleName="pnlInterno">
					<s:VGroup width="100%" height="100" gap="0">
						<s:TextArea id="txtComments" width="100%" height="100%" fontSize="14" keyDown="txtComments_keyDownHandler(event)" borderAlpha="0" contentBackgroundAlpha=".78"
									text="@{recibo.notas}" editable="{!_modoVisualizacion &amp;&amp; !recibo.emitido}" minHeight="0" maxChars="1024" />
					</s:VGroup>
				</s:Panel>
			</s:HGroup>
		</s:VGroup>
	</s:Group>

	<s:controlBarContent>
		<s:HGroup width="100%" horizontalAlign="right" paddingBottom="0" paddingTop="0" verticalAlign="middle">
			<components1:IconButton id="cmdAuditoria" click="cmdAuditoria_clickHandler(event)" styleName="trackingButton" label="Auditoría" toolTip="Líneas auditoría"
									visible="{recibo.docId != null}" includeInLayout="{recibo.docId != null}"/>
			<s:Button id="cmdDocumentos" click="cmdDocumentos_clickHandler(event)" styleName="nuevoButton" label="Documentos" toolTip="Documentos" 
					  focusEnabled="false" visible="true" />

			<s:Spacer width="100%" />

			<mx:Image id="loader1" source="@Embed(source='assets/general/logo_oscuro.gif')" alpha=".5" scaleX=".25" scaleY=".25" />
			
			<s:Spacer width="100%" />

			<s:Button id="cmdNuevo" click="cmdNuevo_clickHandler(event)" styleName="nuevoButton" label="Nuevo" toolTip="Nuevo recibo" focusEnabled="false"
						  visible="{!_modoVisualizacion }" includeInLayout="{!_modoVisualizacion}" />

			<s:Button id="cmdAbrirNotaCredito" click="cmdAbrirNotaCredito_clickHandler(event)" styleName="verButton" label="Visualizar NCF" toolTip="Visualizar N/C 36 Financiera" 
					  focusEnabled="false" visible="{!isAster &amp;&amp; recibo.emitido &amp;&amp; recibo.prevDocId &amp;&amp; recibo.serie != 'A'}" 
					  enabled="{tieneDescuentos}"/>
			<s:Button id="cmdCrearNotaCredito" click="cmdCrearNotaCredito_clickHandler(event)" styleName="nuevoButton" label="Nota Crédito" toolTip="Generar N/C 36 Financiera" 
					  focusEnabled="false" visible="{!isAster &amp;&amp; recibo.emitido &amp;&amp; !recibo.prevDocId &amp;&amp; recibo.serie != 'A'}" 
					  enabled="{tieneDescuentos}"/>
			
			<s:Button id="cmdBorrar" click="cmdBorrar_clickHandler(event)" styleName="trashButton" label="Eliminar" toolTip="Borrar documento"
					  focusEnabled="false" enabled="{!tieneVinculos &amp;&amp; !recibo.nuevo &amp;&amp; !recibo.emitido}"  visible="false" includeInLayout="false"/>
			<s:Button id="cmdGuardar" click="cmdGuardar_clickHandler(event)" styleName="saveButton" label="Guardar" toolTip="Guardar documento" focusEnabled="false" 
					  enabled="{!recibo.emitido &amp;&amp; tieneCambios}" />
			
			<s:Button id="cmdEmitir" click="cmdEmitir_clickHandler(event)" styleName="emitirButton" label="Emitir" toolTip="Emitir" 
					  visible="{!_modoVisualizacion &amp;&amp; !recibo.nuevo}" includeInLayout="{!_modoVisualizacion &amp;&amp; !recibo.nuevo}" 
					  focusEnabled="false" enabled="{(!recibo.emitido &amp;&amp; tieneVinculos) || (recibo.serie == 'P')}" />

			<s:Spacer width="10" />
			<s:Button id="cmdCancel" click="cmdCancel_clickHandler(event)" styleName="cancelarButton" label="Cerrar" toolTip="Cerrar" focusEnabled="false" />
		</s:HGroup>
	</s:controlBarContent>

</s:Panel>
